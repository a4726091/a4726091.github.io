<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA å¤šå°ˆæ¡ˆç®¡ç†ç³»çµ±</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* å…¨åŸŸå­—é«”èˆ‡èƒŒæ™¯è¨­å®š */
        body { font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        
        /* ç”˜ç‰¹åœ–æ¨£å¼è¨­å®š */
        .gantt-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 1.25rem; width: 100%; position: relative; overflow: hidden; }
        .gantt-bar { height: 100%; border-radius: 9999px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.7rem; white-space: nowrap; }
        
        /* è‡ªå®šç¾©æ²è»¸æ¨£å¼ */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* ===== PDF åŒ¯å‡ºå°ˆç”¨æ¨£å¼ (é—œéµæŠ€å·§) ===== */
        /* å°‡æ­¤å€å¡Šç§»å‡ºå¯è¦–ç¯„åœï¼Œä½†ä¿æŒæ¸²æŸ“ç‹€æ…‹ï¼Œä»¥ä¾¿ html2canvas æŠ“å–å®Œæ•´å…§å®¹ */
        

        /* ===== PDF åŒ¯å‡ºå°ˆç”¨æ¨£å¼ (ä¿®æ”¹) ===== */
.pdf-export-hidden {
    position: absolute;
    top: 0;
    left: -99999px;
    width: 1200px; /* A4 æ¯”ä¾‹å¯¬åº¦ */
    background: white;
    padding: 40px; /* å¢åŠ å…§è·è®“ç•«é¢ä¸è²¼é‚Š */
}

/* PDF ç« ç¯€æ¨™é¡Œæ¨£å¼ */
.pdf-section-title {
    margin-top: 40px;
    margin-bottom: 20px;
    padding: 10px;
    background-color: #f3f4f6;
    border-left: 5px solid #2563eb;
    font-size: 1.5rem;
    font-weight: bold;
    color: #1f2937;
}

/* å¼·åˆ¶æ›é æ¨™è¨˜ (è‹¥å…§å®¹å¤ªé•·å¯ç”± JS åµæ¸¬é«˜åº¦ï¼Œæˆ–ç°¡å–®åœ°ç”¨ CSS é–“è·å€éš”) */
.pdf-page-break {
    height: 50px;
    width: 100%;
}

        /* ===== PDF åŒ¯å‡ºæ™‚éš±è—ç‰¹å®šå…ƒç´  ===== */
        /* ç”¨æ–¼éš±è—æŒ‰éˆ•ç­‰ä¸éœ€è¦å‡ºç¾åœ¨å ±è¡¨ä¸Šçš„å…ƒç´  */
        .pdf-export-hidden .pdf-hide {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // è§£æ§‹ React Hook
        const { useState, useEffect } = React;
        
        // å·¥å…·å‡½å¼ï¼šç”¢ç”Ÿéš¨æ©Ÿ ID (Base36 å­—ä¸²)
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // ===== Dashboard è¨ˆç®—å·¥å…·ï¼šè¨ˆç®—å„ Tab çš„é€²åº¦ç™¾åˆ†æ¯” =====
        const calcProjectProgress = (project) => {
            // TAB1ï¼šéƒ¨å“é€æ¨£é€²åº¦ï¼ˆåˆ†æ¯ï¼šç¸½é›¶ä»¶æ•¸ï¼Œåˆ†å­ï¼šç‹€æ…‹ç‚º"çµæ¡ˆ"çš„æ•¸é‡ï¼‰
            const totalParts = project.parts.length;
            const closedParts = project.parts.filter(p => p.status === "çµæ¡ˆ").length;
            const tab1 = totalParts === 0 ? 0 : Math.round(closedParts / totalParts * 100);

            // TAB2ï¼šPPAP æ–‡ä»¶å®Œæˆåº¦ï¼ˆè¨ˆç®—æ‰€æœ‰é›¶ä»¶çš„æ‰€æœ‰æ–‡ä»¶ç‹€æ…‹ï¼‰
            const docKeys = ["drawing", "bubble", "eval", "cp", "sip", "sop"];
            let docDone = 0;
            let docTotal = 0;

            project.parts.forEach(p => {
                const d = project.docs[p.id] || {};
                docKeys.forEach(k => {
                    docTotal++;
                    if (d[k] === 2) docDone++; // ç‹€æ…‹ 2 ä»£è¡¨å·²å®Œæˆ
                });
            });
            const tab2 = docTotal === 0 ? 0 : Math.round(docDone / docTotal * 100);

            // TAB3ï¼šå•é¡Œé»è™•ç†ç‡ï¼ˆåˆ†æ¯ï¼šç¸½å•é¡Œæ•¸ï¼Œåˆ†å­ï¼šå·²ç¢ºèªæœ‰æ•ˆæˆ–ç„¡æ•ˆçš„å•é¡Œï¼‰
            const issues = project.issues || [];
            // æ­¤è™•é‚è¼¯ï¼šåªè¦ç‹€æ…‹æ˜¯ "æœ‰æ•ˆ" è¦–ç‚ºè§£æ±º (å¯æ ¹æ“šéœ€æ±‚ä¿®æ”¹é‚è¼¯)
            const solved = issues.filter(i => i.result === "æœ‰æ•ˆ").length; 
            const tab3 = issues.length === 0 ? 100 : Math.round(solved / issues.length * 100);

            return { tab1, tab2, tab3 };
        };

        /* ===== IndexedDB åŸºç¤å·¥å…·ï¼šç€è¦½å™¨ç«¯è³‡æ–™åº«æ“ä½œ ===== */
        const DB_NAME = "qa-project-db";
        const STORE_NAME = "kv"; // Key-Value å„²å­˜å€
        const DB_VERSION = 2;    // è³‡æ–™åº«ç‰ˆæœ¬

        // é–‹å•Ÿè³‡æ–™åº«ä¸¦è™•ç†ç‰ˆæœ¬å‡ç´š (Schema Migration)
        const openDB = () =>
            new Promise((resolve, reject) => {
                const req = indexedDB.open(DB_NAME, DB_VERSION);
                
                req.onupgradeneeded = (e) => {
                    const db = req.result;
                    const oldVersion = e.oldVersion;

                    switch (oldVersion) {
                        case 0:
                            // v0 âœ v1ï¼šç¬¬ä¸€æ¬¡å»ºç«‹è³‡æ–™åº«ï¼Œæ–°å¢ kv store
                            if (!db.objectStoreNames.contains("kv")) {
                                db.createObjectStore("kv");
                            }
                            // æ³¨æ„ï¼šé€™è£¡ä¸åŠ  breakï¼Œè®“å®ƒç¹¼çºŒå¾€ä¸‹åŸ·è¡Œ (Waterfall pattern)
                        case 1:
                            // v1 âœ v2ï¼šè³‡æ–™çµæ§‹æ‹†åˆ†ï¼Œå°‡ projects ç¨ç«‹å‡ºä¾† (è‹¥æœªä¾†éœ€è¦æ›´ç´°ç·»çš„æŸ¥è©¢)
                            if (!db.objectStoreNames.contains("projects")) {
                                const projectStore = db.createObjectStore("projects");
                                // å˜—è©¦é·ç§»èˆŠè³‡æ–™
                                const tx = e.target.transaction;
                                const kvStore = tx.objectStore("kv");
                                const getReq = kvStore.get("qa-projects");
                                getReq.onsuccess = () => {
                                    const projects = getReq.result || {};
                                    Object.entries(projects).forEach(([id, project]) => {
                                        projectStore.put(project, id);
                                    });
                                };
                            }
                    }
                };

                req.onsuccess = () => resolve(req.result);
                req.onerror = () => reject(req.error);
            });

        // IndexedDB: å¯«å…¥è³‡æ–™
        const idbSet = async (key, value) => {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).put(value, key);
        };

        // IndexedDB: è®€å–è³‡æ–™
        const idbGet = async (key) => {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, "readonly");
            return new Promise(resolve => {
                const req = tx.objectStore(STORE_NAME).get(key);
                req.onsuccess = () => resolve(req.result);
                req.onerror = () => resolve(null);
            });
        };

        // IndexedDB: æ¸…ç©ºè³‡æ–™ (ç”¨æ–¼åŒ¯å…¥æ–°å‚™ä»½å‰)
        const idbClear = async () => {
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, "readwrite");
            tx.objectStore(STORE_NAME).clear();
        };


        // ===== è³‡æ–™å‚™ä»½èˆ‡é‚„åŸåŠŸèƒ½ =====

        // åŒ¯å…¥å‰è‡ªå‹•å‚™ä»½ (é˜²å‘†æ©Ÿåˆ¶)
        const autoBackupBeforeImport = (projects) => {
            const payload = {
                schemaVersion: 2,
                projects
            };
            const blob = new Blob(
                [JSON.stringify(payload, null, 2)],
                { type: "application/json" }
            );
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            // æª”ååŠ ä¸Šæ™‚é–“æˆ³è¨˜
            a.href = url;
            a.download = `QA_AutoBackup_BeforeImport_${new Date().toISOString().replace(/[:.]/g, "-")}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // åŒ¯å‡º JSON å‚™ä»½å‡½å¼
        const exportJSONBackup = (projects) => {
            const payload = {
                schemaVersion: 2,
                projects
            };
            const dataStr = JSON.stringify(payload, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);

            const a = document.createElement("a");
            a.href = url;
            a.download = `QA_Backup_${new Date().toISOString().slice(0,10)}.json`; // æª”åï¼šQA_Backup_2025-01-01.json
            a.click();
            
            // è¨˜éŒ„æœ€å¾Œå‚™ä»½æ™‚é–“
            idbSet("qa-last-backup", Date.now());
            localStorage.setItem("qa-last-backup", Date.now());

            URL.revokeObjectURL(url);
        };

        // æ­£è¦åŒ–åŒ¯å…¥è³‡æ–™ (è™•ç†ä¸åŒç‰ˆæœ¬ Schema)
        const normalizeImportedData = (data) => {
            // v1ï¼šèˆŠç‰ˆæ²’æœ‰ schemaVersionï¼Œç›´æ¥æ˜¯ projects ç‰©ä»¶
            if (!data.schemaVersion) {
                return {
                    schemaVersion: 2,
                    projects: data
                };
            }
            switch (data.schemaVersion) {
                case 1:
                    // é ç•™ç›¸å®¹æ€§è™•ç†
                    return {
                        schemaVersion: 2,
                        projects: data.projects
                    };
                case 2:
                    return data; // ç›®å‰ç‰ˆæœ¬
                default:
                    throw new Error("ä¸æ”¯æ´çš„è³‡æ–™ç‰ˆæœ¬");
            }
        };

        // åŒ¯å…¥ JSON å‚™ä»½æµç¨‹
        const importJSONBackup = (setProjects, setCurrentId) => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "application/json";

            input.onchange = () => {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async () => {
                    try {
                        const rawData = JSON.parse(reader.result);
                        const normalized = normalizeImportedData(rawData);
                        const data = normalized.projects;

                        // ğŸ”’ åŒ¯å…¥å‰è‡ªå‹•å‚™ä»½ç›®å‰è³‡æ–™ï¼ˆé˜²å‘†ï¼‰
                        const currentProjects = (await idbGet("qa-projects")) || {};
                        autoBackupBeforeImport(currentProjects);

                        if (!confirm("å·²è‡ªå‹•å‚™ä»½ç›®å‰è³‡æ–™ã€‚\nç¢ºå®šè¦åŒ¯å…¥ä¸¦è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Ÿ")) {
                            return;
                        }

                        // æ¸…é™¤ IndexedDB åŸè³‡æ–™
                        await idbClear();

                        // æ›´æ–° React State (ä»‹é¢é‡ç¹ª)
                        setProjects(data);

                        // é‡è¨­ç›®å‰é¸ä¸­çš„å°ˆæ¡ˆ ID
                        const firstId = Object.keys(data)[0] || null;
                        setCurrentId(firstId);

                        alert("è³‡æ–™åŒ¯å…¥å®Œæˆ");
                    } catch {
                        alert("JSON æ ¼å¼éŒ¯èª¤ï¼ŒåŒ¯å…¥å¤±æ•—");
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        /* ===== PDF åŒ¯å‡ºåŠŸèƒ½ (æˆªåœ–æ³•) ===== */
        const exportPageToPDF = async () => {
            const { jsPDF } = window.jspdf;

            // âš ï¸ æŠ“å–é å…ˆå®šç¾©å¥½çš„ "å®Œæ•´å…§å®¹" éš±è—å€åŸŸ (æ’é™¤å·¦å´ Sidebar èˆ‡æ²è»¸å½±éŸ¿)
            const content = document.querySelector(".pdf-export-hidden");
            if (!content) {
                alert("æ‰¾ä¸åˆ°åŒ¯å‡ºå€åŸŸ");
                return;
            }

            // ä½¿ç”¨ html2canvas å°‡ DOM è½‰ç‚º Canvas
            const canvas = await html2canvas(content, {
                scale: 1,              // è§£æåº¦å€ç‡
                useCORS: true,         // å…è¨±è·¨åŸŸåœ–ç‰‡ (è‹¥æœ‰)
                backgroundColor: "#ffffff"
            });

            const imgData = canvas.toDataURL("image/png");
            const pdf = new jsPDF("p", "mm", "a4"); // A4 ç¸±å‘

            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            // è¨ˆç®—åœ–ç‰‡åœ¨ PDF ä¸­çš„ç¸®æ”¾å°ºå¯¸
            const imgWidth = pageWidth;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            let heightLeft = imgHeight;
            let position = 0;

            // ç¬¬ä¸€é 
            pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            // ğŸ” è‡ªå‹•åˆ†é é‚è¼¯ï¼šå¦‚æœåœ–ç‰‡é«˜åº¦è¶…éä¸€é ï¼Œå‰‡æ–°å¢é é¢
            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save("QAå°ˆæ¡ˆç•«é¢åŒ¯å‡º.pdf");
        };

        // é è¨­ç¤ºç¯„è³‡æ–™ï¼ˆè‹¥ localStorage/IndexedDB ç‚ºç©ºæ™‚ä½¿ç”¨ï¼‰
        const demoProjects = {
            "proj-2025ev-new": {
                info: { model: "Model-X 2025 (EV)", purpose: "æ–°é–‹ç™¼ä»¶", pm: "Alex Chen", sop: "2025-12-01" },
                parts: [
                    { id: "1", vendor: "ä¾›æ‡‰å•†A", no: "805-A01", name: "å‰ä¿éšªæ¡¿ç¸½æˆ", provisionalMethod: "å¦", date: "2025-05-01", status: "çµæ¡ˆ", checkDate: "2025-05-05", result: "åˆæ ¼", sketch: "", remarks: "", remarksSketch: "" },
                    { id: "2", vendor: "ä¾›æ‡‰å•†B", no: "805-B02", name: "å·¦å¾Œè¦–é¡", provisionalMethod: "æ˜¯", date: "2025-05-10", status: "NGå¾…é‡é€", checkDate: "2025-05-12", result: "NG", sketch: "", remarks: "", remarksSketch: "" },
                ],
                docs: {
                    "1": { drawing: 2, bubble: 2, eval: 2, cp: 2, sip: 1, sop: 0 },
                    "2": { drawing: 2, bubble: 0, eval: 0, cp: 1, sip: 0, sop: 0 },
                },
                issues: [
                    { id: "101", partNo: "805-B02", desc: "é¡é¢çµ„è£é–“éš™éå¤§ (>3mm)", solution: "ä¿®æ­£æ¨¡å…· Slide core", pic: "ç‹å°æ˜", planDate: "2025-05-15", result: "å¾…ç¢ºèª" }
                ],
                tasks: [
                    { id: "201", title: "ç¢ºèªå» å•† ISO9001 è­‰æ›¸æ•ˆæœŸ", pic: "Admin", due: "2025-06-01", done: false }
                ],
                meetings: [
                    { 
                        id: "m1", 
                        date: "2025-05-20", 
                        type: "è©¦æ¨¡æª¢è¨", 
                        subject: "å‰ä¿éšªæ¡¿ T1 è©¦æ¨¡æª¢è¨æœƒ", 
                        attendees: "Alex, ä¾›æ‡‰å•†A", 
                        relatedPartNo: "805-A01", 
                        content: "1. çµåˆç·šä½ç½®éœ€èª¿æ•´\n2. å’¬èŠ±æ·±åº¦ä¸è¶³", 
                        actionItems: "è«‹å» å•†æ–¼ 5/25 å‰æä¾›ä¿®æ­£è¨ˆç•«" 
                    }
                ]
            }
        };

        // ===== å´é‚Šæ¬„çµ„ä»¶ (Sidebar) =====
        const Sidebar = ({
            currentProjectId,
            setCurrentProjectId,
            projects,
            setProjects,
            setCurrentId,
            collapsed,
            setCollapsed,
            setActiveView
        }) => {
            // æ–°å¢å°ˆæ¡ˆ Modal çš„ç‹€æ…‹
            const [showNewProject, setShowNewProject] = useState(false);
            const [newModel, setNewModel] = useState("");
            const [newPurpose, setNewPurpose] = useState("æ–°é–‹ç™¼ä»¶");
            const [newOwner, setNewOwner] = useState("");

            // å»ºç«‹æ–°å°ˆæ¡ˆå‡½å¼
            const createProject = () => {
                if (!newModel.trim()) return alert("è«‹è¼¸å…¥è»Šå‹åç¨±");
                const id = `proj-${Date.now()}`;
                const newProj = {
                    info: { model: newModel, purpose: newPurpose, owner: newOwner || "æœªæŒ‡å®š", sop: "2025-12-31" },
                    parts: [], docs: {}, issues: [], tasks: []
                };
                setProjects(prev => ({ ...prev, [id]: newProj }));
                setCurrentProjectId(id);
                setShowNewProject(false);
                setNewModel("");
            };

            // åˆªé™¤å°ˆæ¡ˆå‡½å¼
            const deleteProject = (id) => {
                if (!confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤å°ˆæ¡ˆï¼Ÿæ‰€æœ‰è³‡æ–™å°‡ç„¡æ³•å¾©åŸ")) return;
                setProjects(prev => {
                    const { [id]: _, ...rest } = prev; // è§£æ§‹è³¦å€¼ç§»é™¤è©² key
                    return rest;
                });
                // è‹¥åˆªé™¤çš„æ˜¯ç•¶å‰å°ˆæ¡ˆï¼Œåˆ‡æ›åˆ°å…¶ä»–å°ˆæ¡ˆ
                if (currentProjectId === id && Object.keys(projects).length > 1) {
                    setCurrentProjectId(Object.keys(projects).find(k => k !== id));
                }
            };

            return (
                <div className={`${collapsed ? "w-20" : "w-72"} bg-slate-800 text-white h-screen fixed left-0 top-0 overflow-y-auto shadow-lg z-10 transition-all duration-300`}>
                    <div className="p-6 border-b border-slate-700">
                        {/* ç³»çµ±æ¨™é¡Œ */}
                        {!collapsed && (
                            <h2 className="text-2xl font-bold flex items-center gap-2">
                                <i className="fas fa-project-diagram text-blue-400"></i> QA PMS
                            </h2>
                        )}

                        {/* æ”¶åˆæŒ‰éˆ• */}
                        <button
                            onClick={() => setCollapsed(v => !v)}
                            className="absolute top-5 right-4 text-slate-300 hover:text-white"
                            title={collapsed ? "å±•é–‹é¸å–®" : "æ”¶åˆé¸å–®"}
                        >
                            <i className={`fas ${collapsed ? "fa-chevron-right" : "fa-chevron-left"}`}></i>
                        </button>

                        {!collapsed && (
                            <p className="text-xs text-slate-400 mt-1">å¤šå°ˆæ¡ˆç®¡ç†ç³»çµ± v3.0</p>
                        )}
                    </div>

                    <div className="p-4 space-y-2">
                        {/* åŒ¯å‡ºæŒ‰éˆ• */}
                        <button
                            onClick={() => exportJSONBackup(projects)}
                            className="w-full bg-slate-600 hover:bg-slate-700 py-2 rounded-lg flex items-center justify-center gap-2 text-sm"
                        >
                            <i className="fas fa-download"></i> {!collapsed && <span>åŒ¯å‡ºå…¨éƒ¨è³‡æ–™</span>}
                        </button>

                        {/* åŒ¯å…¥æŒ‰éˆ• */}
                        <button
                            onClick={() => importJSONBackup(setProjects, setCurrentId)}
                            className="w-full bg-emerald-600 hover:bg-emerald-700 py-2 rounded-lg flex items-center justify-center gap-2 text-sm"
                        >
                            <i className="fas fa-upload"></i> {!collapsed && <span>åŒ¯å…¥è³‡æ–™</span>}
                        </button>

                        {/* åˆ‡æ›è‡³ Dashboard */}
                        <button
                            onClick={() => {
                                setActiveView("dashboard");
                                setActiveTab(null);
                            }}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 py-2 rounded-lg flex items-center justify-center gap-2 text-sm"
                        >
                            <i className="fas fa-chart-pie"></i> å°ˆæ¡ˆç¸½è¦½
                        </button>

                        {/* é–‹å•Ÿæ–°å¢å°ˆæ¡ˆ Modal */}
                        <button
                            onClick={() => setShowNewProject(true)}
                            className="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-lg flex items-center justify-center gap-2 mt-2"
                        >
                            <i className="fas fa-plus"></i>  {!collapsed && <span>æ–°å¢å°ˆæ¡ˆ</span>}
                        </button>
                    </div>

                    {/* å°ˆæ¡ˆåˆ—è¡¨å€å¡Š */}
                    {!collapsed && (
                        <nav className="px-4 space-y-2">
                            <p className="text-xs uppercase text-slate-500 px-2 mb-2">å°ˆæ¡ˆåˆ—è¡¨</p>
                            {Object.entries(projects).map(([id, p]) => (
                                <div key={id} className={`rounded-lg overflow-hidden ${currentProjectId === id ? 'ring-2 ring-blue-400' : ''}`}>
                                    <button
                                        onClick={() => {
                                            setCurrentProjectId(id);
                                            setActiveView("project");
                                        }}
                                        className={`w-full text-left p-4 text-left transition ${currentProjectId === id ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'}`}
                                    >
                                        {!collapsed && (    
                                            <div className="font-medium truncate">{p.info.model}</div>
                                        )}
                                        <div className="text-xs opacity-90 mt-1">
                                            <span className="inline-block px-2 py-0.5 bg-white bg-opacity-20 rounded">
                                                {p.info.purpose}
                                            </span>
                                        </div>
                                        <div className="text-xs mt-1 opacity-75">æ“”ç•¶: {p.info.owner || "æœªæŒ‡å®š"}</div>
                                    </button>
                                    {/* åˆªé™¤æŒ‰éˆ• (åƒ…åœ¨é¸ä¸­ä¸”éå”¯ä¸€å°ˆæ¡ˆæ™‚é¡¯ç¤º) */}
                                    {currentProjectId === id && Object.keys(projects).length > 1 && (
                                        <button onClick={() => deleteProject(id)} className="w-full bg-red-600 hover:bg-red-700 py-2 text-sm">
                                            <i className="fas fa-trash mr-1"></i> åˆªé™¤å°ˆæ¡ˆ
                                        </button>
                                    )}
                                </div>
                            ))}
                        </nav>
                    )}  

                    {/* æ–°å¢å°ˆæ¡ˆ Modal */}
                    {showNewProject && (
                        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50" onClick={() => setShowNewProject(false)}>
                            <div className="bg-white text-gray-800 rounded-xl p-6 w-96 shadow-2xl" onClick={e => e.stopPropagation()}>
                                <h3 className="text-lg font-bold mb-4">æ–°å¢å°ˆæ¡ˆ</h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium mb-1">è»Šå‹</label>
                                        <input value={newModel} onChange={e => setNewModel(e.target.value)} className="w-full border rounded-lg px-3 py-2" placeholder="ä¾‹ï¼šModel-Y 2026" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">ç›®çš„</label>
                                        <select value={newPurpose} onChange={e => setNewPurpose(e.target.value)} className="w-full border rounded-lg px-3 py-2">
                                            <option>æ–°é–‹ç™¼ä»¶</option>
                                            <option>è¨­è¨ˆè®Šæ›´</option>
                                            <option>å·¥ç¨‹è®Šæ›´</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium mb-1">æ“”ç•¶</label>
                                        <input
                                            value={newOwner}
                                            onChange={e => setNewOwner(e.target.value)}
                                            className="w-full border rounded-lg px-3 py-2"
                                            placeholder="ä¾‹ï¼šç‹å°æ˜"
                                        />
                                    </div>
                                    <div className="flex justify-end gap-3 pt-4">
                                        <button onClick={() => setShowNewProject(false)} className="px-5 py-2 text-gray-600">å–æ¶ˆ</button>
                                        <button onClick={createProject} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å»ºç«‹å°ˆæ¡ˆ</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ===== å°ˆæ¡ˆæ¨™é ­çµ„ä»¶ (é¡¯ç¤ºåŸºæœ¬è³‡è¨Šèˆ‡æ•´é«”é€²åº¦) =====
        const ProjectHeader = ({ project }) => {
            // æ ¹æ“šå°ˆæ¡ˆç›®çš„è¨­å®šæ¨™ç±¤é¡è‰²
            const purposeStyle = project.info.purpose === "æ–°é–‹ç™¼ä»¶" ? "bg-blue-100 text-blue-800" :
                                project.info.purpose === "è¨­è¨ˆè®Šæ›´" ? "bg-purple-100 text-purple-800" :
                                "bg-orange-100 text-orange-800";
            
            // è¨ˆç®—ç°¡æ˜“æ•´é«”é€²åº¦
            const totalParts = project.parts.length;
            const submitted = project.parts.filter(p => p.date).length;
            const pendingSubmit = totalParts - submitted;
            const measured = project.parts.filter(p => p.result === "åˆæ ¼" || p.result === "NG").length;
            const qualified = project.parts.filter(p => p.result === "åˆæ ¼").length;
            const ng = project.parts.filter(p => p.result === "NG").length;
            const pendingVerify = submitted - measured;
            // ç¸½é€²åº¦ = çµæ¡ˆæ•¸ / ç¸½æ•¸
            const overall = totalParts > 0 ? Math.round(
                project.parts.filter(p => p.status === "çµæ¡ˆ").length / totalParts * 100
            ) : 0;

            return (
                <div className="bg-white p-6 rounded-xl shadow-sm mb-6 flex justify-between items-center border border-gray-100">
                    <div>
                        <span className={`${purposeStyle} text-xs font-bold px-3 py-1 rounded-full inline-block mb-2`}>
                            {project.info.purpose}
                        </span>
                        <h1 className="text-2xl font-bold text-slate-800">{project.info.model}</h1>
                        <div className="text-slate-500 text-sm mt-2 flex gap-6">
                            <span className="flex items-center gap-2">
                                <i className="fas fa-user"></i>
                                æ“”ç•¶ï¼š
                                {/* ç›´æ¥ä¿®æ”¹æ“”ç•¶ input */}
                                <input
                                    value={project.info.owner || ""}
                                    onChange={e =>
                                        project.info.owner = e.target.value
                                    }
                                    onBlur={() => {}}
                                    className="border rounded px-2 py-0.5 text-sm w-28"
                                    placeholder="è¼¸å…¥æ“”ç•¶"
                                />
                            </span>
                        </div>
                    </div>
                    <div className="flex items-center gap-6">
                        {/* é€²åº¦çµ±è¨ˆå€å¡Š */}
                        <div className="text-right">
                            <div className="text-sm text-slate-500">æ•´é«”é€²åº¦</div>
                            <div className="text-3xl font-bold text-blue-600">{overall}%</div>
                            <div className="text-sm text-gray-600 mt-2">
                                æ‡‰é€æª¢: {totalParts}ä»¶<br/>
                                å·²é€æª¢: {submitted}ä»¶<br/>
                                å¾…é€æª¢: {pendingSubmit}ä»¶<br/>
                                é‡æ¸¬å®Œæˆ: {measured}ä»¶<br/>
                                åˆæ ¼: {qualified}ä»¶<br/>
                                NG: {ng}ä»¶<br/>
                                å¾…é©—: {pendingVerify}ä»¶
                            </div>
                        </div>

                        {/* PDF åŒ¯å‡ºæŒ‰éˆ• */}
                        <button
                            onClick={exportPageToPDF}
                            className="bg-red-600 text-white px-5 py-3 rounded-lg hover:bg-red-700 shadow-sm pdf-hide"
                        >
                            <i className="fas fa-file-pdf mr-2"></i>åŒ¯å‡ºç›®å‰ç•«é¢
                        </button>
                    </div>
                </div>
            );
        };

        // ===== Tab1: éƒ¨å“é€æ¨£æ¸…å–®çµ„ä»¶ =====
        const Tab1_Submission = ({ project, updateProject }) => {
            // å®šç¾© Modal é–‹é—œèˆ‡ç·¨è¼¯ç‹€æ…‹
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editItem, setEditItem] = useState(null);
            
            // å®šç¾©åœ–ç‰‡é è¦½ç‹€æ…‹ (ä¸€èˆ¬ç°¡åœ– / å‚™è¨»ç°¡åœ–)
            const [sketchPreview, setSketchPreview] = useState("");
            const [remarksSketchPreview, setRemarksSketchPreview] = useState("");
            // é»æ“Šåœ–ç‰‡æ”¾å¤§çš„ç‹€æ…‹
            const [selectedSketch, setSelectedSketch] = useState(null);

            // è™•ç† Excel / CSV åŒ¯å…¥åŠŸèƒ½
            const handleImportParts = () => {
                const input = document.createElement("input");
                input.type = "file";
                input.accept = ".xlsx,.xls,.csv";

                input.onchange = async () => {
                    const file = input.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        // ä½¿ç”¨ SheetJS è®€å–
                        const workbook = XLSX.read(data, { type: "array" });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet);

                        /**
                         * Excel / CSV æ¬„ä½å°æ‡‰é‚è¼¯ï¼š
                         * å‡è¨­æ¬„ä½åç¨±ç‚ºï¼šå» å•† | ä»¶è™Ÿ | ä»¶å
                         */

                         //å» å•†	ä»¶è™Ÿ	ä»¶å	æ˜¯å¦ä»¥æš«å®šå·¥æ³•	é€æ¨£æ™‚é–“	ç‹€æ…‹	æª¢æŸ¥æ—¥	çµæœ	é€²åº¦é è¦½	å‚™è¨»	æ“ä½œ
                        const importedParts = rows.map(r => ({
                            id: generateId(),
                                // åŸºæœ¬æ¬„ä½
    vendor: r["å» å•†"] || "",
    no: r["ä»¶è™Ÿ"] || "",
    name: r["ä»¶å"] || "",

    // ğŸ”½ è¿½åŠ å¯åŒ¯å…¥æ¬„ä½
    provisionalMethod: r["æ˜¯å¦ä»¥æš«å®šå·¥æ³•"] || "å¦",
    date: r["é€æ¨£æ™‚é–“"] || "",
    status: r["ç‹€æ…‹"] || "å¾…é€æ¨£",
    checkDate: r["æª¢æŸ¥æ—¥"] || "",
    result: r["çµæœ"] || "",

    // é€²åº¦é è¦½æ˜¯ã€Œç”±ç‹€æ…‹æ¨å°ã€ï¼Œä¸ç›´æ¥å­˜å€¼
    // ï¼ˆç”˜ç‰¹æ¢æœƒè‡ªå‹•è·Ÿ status èµ°ï¼‰
    
    remarks: r["å‚™è¨»"] || "",

    // åœ–ç‰‡ä»ç¶­æŒæ‰‹å‹•ä¸Šå‚³
    sketch: "",
    remarksSketch: ""
                        }));

                        // æ›´æ–°å°ˆæ¡ˆï¼šåˆä½µèˆŠè³‡æ–™èˆ‡æ–°åŒ¯å…¥è³‡æ–™ï¼Œä¸¦åˆå§‹åŒ– docs çµæ§‹
                        updateProject(p => ({
                            ...p,
                            parts: [...p.parts, ...importedParts],
                            docs: {
                                ...p.docs,
                                ...Object.fromEntries(
                                    importedParts.map(x => [
                                        x.id,
                                        { drawing: 0, bubble: 0, eval: 0, cp: 0, sip: 0, sop: 0 }
                                    ])
                                )
                            }
                        }));

                        alert(`æˆåŠŸåŒ¯å…¥ ${importedParts.length} ç­†é›¶ä»¶`);
                    };
                    reader.readAsArrayBuffer(file);
                };
                input.click();
            };

            // ç•¶ç·¨è¼¯é …ç›®æ”¹è®Šæ™‚ï¼ŒåŒæ­¥æ›´æ–°åœ–ç‰‡é è¦½
            useEffect(() => {
                if (editItem) {
                    setSketchPreview(editItem.sketch || "");
                    setRemarksSketchPreview(editItem.remarksSketch || "");
                } else {
                    setSketchPreview("");
                    setRemarksSketchPreview("");
                }
            }, [editItem]);

            // è™•ç†è¡¨å–®å„²å­˜ (æ–°å¢æˆ–æ›´æ–°)
            const handleSave = async (e) => {
                e.preventDefault();
                const f = new FormData(e.target);
                
                // è™•ç†ç°¡åœ–ä¸Šå‚³ (è½‰æ›ç‚º Base64)
                const file = f.get("sketch");
                let sketchData = editItem ? editItem.sketch : "";
                if (file && file.size > 0) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    await new Promise((resolve) => {
                        reader.onload = () => {
                            sketchData = reader.result;
                            resolve();
                        };
                    });
                }
                
                // è™•ç†å‚™è¨»ç°¡åœ–ä¸Šå‚³
                const remarksFile = f.get("remarksSketch");
                let remarksSketchData = editItem ? editItem.remarksSketch : "";
                if (remarksFile && remarksFile.size > 0) {
                    const reader = new FileReader();
                    reader.readAsDataURL(remarksFile);
                    await new Promise((resolve) => {
                        reader.onload = () => {
                            remarksSketchData = reader.result;
                            resolve();
                        };
                    });
                }

                // å»ºç«‹è³‡æ–™ç‰©ä»¶
                const item = {
                    id: editItem ? editItem.id : generateId(),
                    vendor: f.get("vendor"),
                    no: f.get("no"),
                    name: f.get("name"),
                    provisionalMethod: f.get("provisionalMethod"),
                    date: f.get("date"),
                    status: f.get("status"),
                    checkDate: f.get("checkDate") || "",
                    result: f.get("result") || "",
                    sketch: sketchData,
                    remarks: f.get("remarks") || "",
                    remarksSketch: remarksSketchData
                };

                // æ›´æ–° State
                if (editItem) {
                    updateProject(p => ({ ...p, parts: p.parts.map(x => x.id === item.id ? item : x) }));
                } else {
                    updateProject(p => ({
                        ...p,
                        parts: [...p.parts, item],
                        docs: { ...p.docs, [item.id]: { drawing: 0, bubble: 0, eval: 0, cp: 0, sip: 0, sop: 0 } }
                    }));
                }
                setIsModalOpen(false);
                setEditItem(null);
                setSketchPreview("");
                setRemarksSketchPreview("");
            };

            // åˆªé™¤é›¶ä»¶
            const handleDelete = (id) => {
                if (confirm("ç¢ºå®šåˆªé™¤æ­¤é›¶ä»¶ï¼Ÿç›¸é—œæ–‡ä»¶è³‡æ–™ä¹Ÿæœƒä¸€ä½µç§»é™¤")) {
                    updateProject(p => {
                        const { [id]: _, ...newDocs } = p.docs; // ç§»é™¤å°æ‡‰çš„ doc
                        return { ...p, parts: p.parts.filter(x => x.id !== id), docs: newDocs };
                    });
                }
            };

            // ç‹€æ…‹é¡è‰²å°æ‡‰
            const getStatusColor = (s) => {
                switch(s) {
                    case "çµæ¡ˆ": return "bg-green-500";
                    case "NGå¾…é‡é€": return "bg-red-500";
                    case "å¾…æª¢": return "bg-blue-500";
                    default: return "bg-gray-400";
                }
            };

            // ç”˜ç‰¹åœ–å¯¬åº¦å°æ‡‰ (è¦–è¦ºåŒ–é€²åº¦)
            const getGanttWidth = (s) => {
                const map = { "çµæ¡ˆ": "100%", "NGå¾…é‡é€": "40%", "å¾…æª¢": "60%" };
                return map[s] || "20%";
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <h3 className="font-bold text-gray-700">1. éƒ¨å“é€æ¨£æ¸…å–®</h3>
                        <div className="flex gap-2">
                            <button
                                onClick={handleImportParts}
                                className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-md text-sm pdf-hide"
                            >
                                <i className="fas fa-file-import mr-1"></i> åŒ¯å…¥ Excel / CSV
                            </button>
                            <button
                                onClick={() => { setEditItem(null); setIsModalOpen(true); }}
                                className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm pdf-hide"
                            >
                                <i className="fas fa-plus mr-1"></i> æ–°å¢é›¶ä»¶
                            </button>
                        </div>
                    </div>
                    
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm">
                            <thead className="bg-gray-50 text-xs uppercase text-gray-700">
                                <tr>
                                    <th className="px-4 py-3 text-left">åºåˆ—</th>
                                    <th className="px-4 py-3 text-left">å» å•†</th>
                                    <th className="px-4 py-3 text-left">ä»¶è™Ÿ</th>
                                    <th className="px-4 py-3 text-left">ä»¶å</th>
                                    <th className="px-4 py-3">æ˜¯å¦ä»¥æš«å®šå·¥æ³•</th>
                                    <th className="px-4 py-3">é€æ¨£æ™‚é–“</th>
                                    <th className="px-4 py-3">ç‹€æ…‹</th>
                                    <th className="px-4 py-3">æª¢æŸ¥æ—¥</th>
                                    <th className="px-4 py-3">çµæœ</th>
                                    
                                    <th className="px-4 py-3">å‚™è¨»</th>
                                    <th className="px-4 py-3 text-right pdf-hide">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {project.parts.map((p, index) => (
                                    <tr key={p.id} className="border-b hover:bg-gray-50">
                                        <td className="px-4 py-3">{index + 1}</td>
                                        <td className="px-4 py-3">{p.vendor}</td>
                                        <td className="px-4 py-3 font-medium">{p.no}</td>
                                        <td className="px-4 py-3 flex items-center">
                                            {p.name}
                                            {/* é¡¯ç¤ºç°¡åœ–ç¸®åœ–ï¼Œé»æ“Šå¯æ”¾å¤§ */}
                                            {p.sketch && <img src={p.sketch} alt="ç°¡åœ–" className="ml-2 w-10 h-10 object-contain rounded cursor-pointer" onClick={() => setSelectedSketch(p.sketch)} />}
                                        </td>
                                        <td className="px-4 py-3">{p.provisionalMethod}</td>
                                        <td className="px-4 py-3">{p.date}</td>
                                        <td className="px-4 py-3"><span className={`${getStatusColor(p.status)} text-white px-2 py-1 rounded text-xs`}>{p.status}</span></td>
                                        <td className="px-4 py-3">{p.checkDate || "-"}</td>
                                        <td className="px-4 py-3 font-bold" style={{color: p.result==="åˆæ ¼"?"green":p.result==="NG"?"red":"gray"}}>{p.result || "-"}</td>
                                        
                                        <td className="px-4 py-3 whitespace-pre-line">
                                            {p.remarks}
                                            {/* é¡¯ç¤ºå‚™è¨»åœ–ç¸®åœ– */}
                                            {p.remarksSketch && <img src={p.remarksSketch} alt="å‚™è¨»ç°¡åœ–" className="ml-2 w-10 h-10 object-contain rounded cursor-pointer" onClick={() => setSelectedSketch(p.remarksSketch)} />}
                                        </td>
                                        <td className="px-4 py-3 text-right pdf-hide">
                                            <button onClick={() => { setEditItem(p); setIsModalOpen(true); }} className="text-blue-600 mr-3"><i className="fas fa-edit"></i></button>
                                            <button onClick={() => handleDelete(p.id)} className="text-red-500"><i className="fas fa-trash-alt"></i></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {project.parts.length === 0 && <div className="text-center py-8 text-gray-400">å°šæœªæ–°å¢ä»»ä½•é›¶ä»¶</div>}
                    </div>

                    {/* æ–°å¢/ç·¨è¼¯ Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl w-[800px] max-h-[80vh] flex flex-col">
                                <h3 className="text-lg font-bold mb-4">{editItem ? "ç·¨è¼¯é›¶ä»¶" : "æ–°å¢é›¶ä»¶"}</h3>
                                <form onSubmit={handleSave} className="flex-1 overflow-y-auto p-6 space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium">å» å•†</label>
                                        <input name="vendor" defaultValue={editItem?.vendor} className="w-full border rounded p-2"/>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium">ä»¶è™Ÿ</label><input name="no" defaultValue={editItem?.no} required className="w-full border rounded p-2"/></div>
                                        <div><label className="block text-sm font-medium">ä»¶å</label><input name="name" defaultValue={editItem?.name} required className="w-full border rounded p-2"/></div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">æ˜¯å¦ä»¥æš«å®šå·¥æ³•</label>
                                        <select name="provisionalMethod" defaultValue={editItem?.provisionalMethod || "å¦"} className="w-full border rounded p-2">
                                            <option>æ˜¯</option>
                                            <option>å¦</option>
                                        </select>
                                    </div>
                                    <div><label className="block text-sm font-medium">é€æ¨£æ™‚é–“</label><input type="date" name="date" defaultValue={editItem?.date} className="w-full border rounded p-2"/></div>
                                    <div><label className="block text-sm font-medium">æª¢æŸ¥æ—¥</label><input type="date" name="checkDate" defaultValue={editItem?.checkDate} className="w-full border rounded p-2"/></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-medium">ç‹€æ…‹</label>
                                            <select name="status" defaultValue={editItem?.status || "å¾…é€æ¨£"} className="w-full border rounded p-2">
                                                <option>å¾…é€æ¨£</option><option>å¾…æª¢</option><option>NGå¾…é‡é€</option><option>çµæ¡ˆ</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium">çµæœ</label>
                                            <select name="result" defaultValue={editItem?.result || "-"} className="w-full border rounded p-2">
                                                <option>-</option><option>åˆæ ¼</option><option>NG</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">ä¸Šå‚³ç°¡åœ–</label>
                                        <input type="file" name="sketch" accept="image/*" className="w-full border rounded p-2"/>
                                        {sketchPreview && <img src={sketchPreview} alt="é è¦½" className="mt-2 w-20 h-20 object-contain"/>}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">å‚™è¨»</label>
                                        <textarea name="remarks" defaultValue={editItem?.remarks} className="w-full border rounded p-2" rows="3"></textarea>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">ä¸Šå‚³å‚™è¨»ç°¡åœ–</label>
                                        <input type="file" name="remarksSketch" accept="image/*" className="w-full border rounded p-2"/>
                                        {remarksSketchPreview && <img src={remarksSketchPreview} alt="å‚™è¨»é è¦½" className="mt-2 w-20 h-20 object-contain"/>}
                                    </div>
                                    <div className="flex justify-end gap-3 mt-6">
                                        <button type="button" onClick={() => {setIsModalOpen(false); setEditItem(null); setSketchPreview(""); setRemarksSketchPreview("");}} className="px-4 py-2 text-gray-600">å–æ¶ˆ</button>
                                        <button type="submit" className="px-5 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">å„²å­˜</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                    
                    {/* åœ–ç‰‡æ”¾å¤§æª¢è¦– Modal */}
                    {selectedSketch && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onClick={() => setSelectedSketch(null)}>
                            <div className="bg-white rounded-lg p-4 max-w-4xl max-h-screen overflow-auto" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-end">
                                    <button onClick={() => setSelectedSketch(null)} className="text-gray-600 hover:text-gray-800">
                                        <i className="fas fa-times text-xl"></i>
                                    </button>
                                </div>
                                <img src={selectedSketch} alt="æ”¾å¤§ç°¡åœ–" className="max-w-full max-h-[80vh] object-contain" />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ===== Tab2: PPAP æ–‡ä»¶çŸ©é™£çµ„ä»¶ =====
        const Tab2_Docs = ({ project, updateProject }) => {
            const docTypes = [
                { key: "drawing", label: "åœ–é¢" },
                { key: "bubble", label: "æ³¡æ³¡åœ–" },
                { key: "eval", label: "è©•åƒ¹è¡¨" },
                { key: "cp", label: "ç®¡åˆ¶è¨ˆç•«" },
                { key: "sip", label: "æª¢é©—æ¨™æº–" },
                { key: "sop", label: "ä½œæ¥­æ¨™æº–" },
            ];

            // åˆ‡æ›ç‹€æ…‹é‚è¼¯ï¼š0(æœªä¸Šå‚³) -> 1(å¯©æ ¸ä¸­) -> 2(å·²ç¢ºèª) -> 0...
            const toggle = (partId, key) => {
                updateProject(p => ({
                    ...p,
                    docs: {
                        ...p.docs,
                        [partId]: {
                            ...(p.docs[partId] || {}),
                            [key]: ((p.docs[partId]?.[key] || 0) + 1) % 3
                        }
                    }
                }));
            };

            // å–å¾—å°æ‡‰åœ–ç¤º Class
            const getIcon = (v) => {
                if (v === 2) return "text-green-500 fa-check-circle";
                if (v === 1) return "text-yellow-500 fa-clock";
                return "text-gray-300 fa-circle";
            };

            // è¨ˆç®—å–®ä¸€é›¶ä»¶çš„æ–‡ä»¶å®Œæˆåº¦
            const progress = (partId) => {
                const d = project.docs[partId] || {};
                const done = docTypes.filter(t => d[t.key] === 2).length;
                return Math.round(done / docTypes.length * 100);
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <h3 className="font-bold text-gray-700">2. PPAP è³‡æ–™æº–å‚™ç‹€æ³</h3>
                        <div className="text-xs text-gray-500 flex gap-4 items-center">
                            <span><i className="fas fa-circle text-gray-300"></i> æœªä¸Šå‚³</span>
                            <span><i className="fas fa-clock text-yellow-500"></i> å¯©æ ¸ä¸­</span>
                            <span><i className="fas fa-check-circle text-green-500"></i> å·²ç¢ºèª</span>
                        </div>
                    </div>
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50 text-xs uppercase text-gray-700">
                            <tr>
                                <th className="px-4 py-3 text-left">ä»¶è™Ÿ / ä»¶å</th>
                                {docTypes.map(d => <th key={d.key} className="px-2 py-3">{d.label}</th>)}
                                <th className="px-4 py-3">å®Œæˆåº¦</th>
                            </tr>
                        </thead>
                        <tbody>
                            {project.parts.map(part => {
                                const prog = progress(part.id);
                                return (
                                    <tr key={part.id} className="border-b hover:bg-gray-50">
                                        <td className="px-4 py-3 text-left">
                                            <div className="font-medium">{part.no}</div>
                                            <div className="text-xs text-gray-500">{part.name}</div>
                                        </td>
                                        {/* é»æ“Šåœ–ç¤ºåˆ‡æ›ç‹€æ…‹ */}
                                        {docTypes.map(d => (
                                            <td key={d.key} className="text-center cursor-pointer" onClick={() => toggle(part.id, d.key)}>
                                                <i className={`fas ${getIcon(project.docs[part.id]?.[d.key])} text-lg`}></i>
                                            </td>
                                        ))}
                                        <td className="px-4 py-3">
                                            <div className="w-32 bg-gray-200 rounded-full h-2">
                                                <div className="bg-blue-600 h-2 rounded-full" style={{width: `${prog}%`}}></div>
                                            </div>
                                            <span className="text-xs text-gray-500">{prog}%</span>
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    {project.parts.length === 0 && <div className="text-center py-8 text-gray-400">å°šæœªæœ‰éƒ¨å“è³‡æ–™</div>}
                </div>
            );
        };

        // ===== Tab3: å•é¡Œé»è¿½è¹¤çµ„ä»¶ =====
        const Tab3_Issues = ({ project, updateProject }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [edit, setEdit] = useState(null);

            // å„²å­˜å•é¡Œé»
            const save = (e) => {
                e.preventDefault();
                const f = new FormData(e.target);
                const item = {
                    id: edit ? edit.id : generateId(),
                    partNo: f.get("partNo"),
                    desc: f.get("desc"),
                    solution: f.get("solution"),
                    pic: f.get("pic"),
                    planDate: f.get("planDate"),
                    result: f.get("result")
                };
                if (edit) {
                    updateProject(p => ({ ...p, issues: p.issues.map(i => i.id === item.id ? item : i) }));
                } else {
                    updateProject(p => ({ ...p, issues: [...p.issues, item] }));
                }
                setIsOpen(false);
                setEdit(null);
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="p-4 bg-gray-50 border-b flex justify-between">
                        <h3 className="font-bold text-gray-700">3. å•é¡Œé»è¿½è¹¤</h3>
                        <button onClick={() => { setEdit(null); setIsOpen(true); }} className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm">
                            <i className="fas fa-plus mr-1"></i> æ–°å¢å•é¡Œ
                        </button>
                    </div>
                    <table className="w-full text-sm">
                        <thead className="bg-gray-50 text-xs uppercase">
                            <tr>
                                <th className="px-4 py-3 text-left">ä»¶è™Ÿ</th>
                                <th className="px-4 py-3">å•é¡Œæè¿°</th>
                                <th className="px-4 py-3">å°ç­–</th>
                                <th className="px-4 py-3">æ“”ç•¶</th>
                                <th className="px-4 py-3">é å®šå®Œæˆ</th>
                                <th className="px-4 py-3">ç¢ºèª</th>
                                <th className="px-4 py-3 text-right">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {project.issues.map(i => (
                                <tr key={i.id} className="border-b hover:bg-gray-50">
                                    <td className="px-4 py-3 font-medium">{i.partNo}</td>
                                    <td className="px-4 py-3 text-red-600">{i.desc}</td>
                                    <td className="px-4 py-3 text-gray-600">{i.solution}</td>
                                    <td className="px-4 py-3"><span className="bg-gray-100 px-2 py-1 rounded text-xs">{i.pic}</span></td>
                                    <td className="px-4 py-3">{i.planDate}</td>
                                    <td className="px-4 py-3">
                                        <span className={`px-2 py-1 rounded text-xs text-white ${i.result === "æœ‰æ•ˆ" ? "bg-green-500" : "bg-orange-500"}`}>
                                            {i.result || "å¾…ç¢ºèª"}
                                        </span>
                                    </td>
                                    <td className="px-4 py-3 text-right">
                                        <button onClick={() => { setEdit(i); setIsOpen(true); }} className="text-blue-600 mr-3"><i className="fas fa-edit"></i></button>
                                        <button onClick={() => updateProject(p => ({ ...p, issues: p.issues.filter(x => x.id !== i.id) }))} className="text-red-500"><i className="fas fa-trash-alt"></i></button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    {project.issues.length === 0 && <div className="text-center py-8 text-gray-400">å°šç„¡å•é¡Œé»</div>}
                    
                    {/* æ–°å¢/ç·¨è¼¯ Modal */}
                    {isOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 w-full max-w-lg">
                                <h3 className="text-lg font-bold mb-4">{edit ? "ç·¨è¼¯" : "æ–°å¢"}å•é¡Œé»</h3>
                                <form onSubmit={save} className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium">é—œè¯ä»¶è™Ÿ</label>
                                        <select name="partNo" defaultValue={edit?.partNo} className="w-full border rounded p-2">
                                            {project.parts.map(p => <option key={p.id} value={p.no}>{p.no} {p.name}</option>)}
                                        </select>
                                    </div>
                                    <textarea name="desc" defaultValue={edit?.desc} placeholder="å•é¡Œæè¿°" rows="2" required className="w-full border rounded p-2"></textarea>
                                    <textarea name="solution" defaultValue={edit?.solution} placeholder="å°ç­–å…§å®¹" rows="2" required className="w-full border rounded p-2"></textarea>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium">æ“”ç•¶</label><input name="pic" defaultValue={edit?.pic} className="w-full border rounded p-2"/></div>
                                        <div><label className="block text-sm font-medium">é å®šå®Œæˆæ—¥</label><input type="date" name="planDate" defaultValue={edit?.planDate} className="w-full border rounded p-2"/></div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium">æ•ˆæœç¢ºèª</label>
                                        <select name="result" defaultValue={edit?.result || "å¾…ç¢ºèª"} className="w-full border rounded p-2">
                                            <option>å¾…ç¢ºèª</option><option>æœ‰æ•ˆ</option><option>ç„¡æ•ˆ</option>
                                        </select>
                                    </div>
                                    <div className="flex justify-end gap-3">
                                        <button type="button" onClick={() => {setIsOpen(false); setEdit(null);}} className="px-4 py-2 text-gray-600">å–æ¶ˆ</button>
                                        <button type="submit" className="px-5 py-2 bg-blue-600 text-white rounded">å„²å­˜</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // ===== Tab4: å…¶ä»–ä»»å‹™ To-Do List çµ„ä»¶ =====
        const Tab4_Tasks = ({ project, updateProject }) => {
            const [newTask, setNewTask] = useState("");
            
            // æ–°å¢ä»»å‹™
            const add = () => {
                if (!newTask.trim()) return;
                updateProject(p => ({
                    ...p,
                    tasks: [...p.tasks, { id: generateId(), title: newTask, pic: "æˆ‘", due: new Date().toISOString().split("T")[0], done: false }]
                }));
                setNewTask("");
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-6 max-w-4xl mx-auto">
                    <h3 className="font-bold mb-6 flex justify-between items-center">
                        <span><i className="fas fa-clipboard-list mr-2"></i> å…¶ä»–å¾…è¾¦äº‹é …</span>
                        <span className="text-sm text-gray-500">{project.tasks.filter(t => t.done).length} / {project.tasks.length} å®Œæˆ</span>
                    </h3>
                    <div className="flex gap-3 mb-6">
                        <input
                            type="text"
                            value={newTask}
                            onChange={e => setNewTask(e.target.value)}
                            onKeyPress={e => e.key === "Enter" && add()}
                            placeholder="è¼¸å…¥æ–°ä»»å‹™..."
                            className="flex-1 border rounded-lg px-4 py-2"/>
                        <button onClick={add} className="bg-blue-600 text-white px-6 rounded-lg hover:bg-blue-700">æ–°å¢</button>
                    </div>
                    <div className="space-y-3">
                        {project.tasks.map(t => (
                            <div key={t.id} className={`flex items-center p-4 rounded-lg border ${t.done ? "bg-gray-50" : "bg-white"}`}>
                                <input type="checkbox" checked={t.done} onChange={() => updateProject(p => ({
                                    ...p, tasks: p.tasks.map(x => x.id === t.id ? {...x, done: !x.done} : x)
                                }))} className="mr-4 w-5 h-5"/>
                                <div className="flex-1">
                                    <div className={`${t.done ? "line-through text-gray-400" : ""}`}>{t.title}</div>
                                    <div className="text-xs text-gray-500">Due: {t.due} â€¢ {t.pic}</div>
                                </div>
                                <button onClick={() => updateProject(p => ({ ...p, tasks: p.tasks.filter(x => x.id !== t.id) }))} className="text-gray-400 hover:text-red-500">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                        ))}
                        {project.tasks.length === 0 && <div className="text-center text-gray-400 py-8">å°šç„¡å¾…è¾¦äº‹é …</div>}
                    </div>
                </div>
            );
        };
        
        // ===== Tab5: æœƒè­°ç´€éŒ„çµ„ä»¶ =====
        const Tab5_Meetings = ({ project, updateProject }) => {
            // åœ–ç‰‡é è¦½ç‹€æ…‹
            const [picPreview, setPicPreview] = useState("");
            const [selectedImg, setSelectedImg] = useState(null);
            
            const [isOpen, setIsOpen] = useState(false);
            const [edit, setEdit] = useState(null);

            // ç•¶ç·¨è¼¯ç‹€æ…‹æ”¹è®Šæ™‚ï¼Œè¼‰å…¥å·²å­˜åœ¨çš„åœ–ç‰‡
            useEffect(() => {
                if (edit) {
                    setPicPreview(edit.pic || "");
                } else {
                    setPicPreview("");
                }
            }, [edit]);

            // å„²å­˜æœƒè­°ç´€éŒ„
            const save = async (e) => {
                e.preventDefault();
                const f = new FormData(e.target);
                
                // è™•ç†åœ–ç‰‡ä¸Šå‚³
                const file = f.get("meetingPic");
                let picData = edit ? edit.pic : "";
                if (file && file.size > 0) {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    await new Promise((resolve) => {
                        reader.onload = () => {
                            picData = reader.result;
                            resolve();
                        };
                    });
                }

                const item = {
                    id: edit ? edit.id : generateId(),
                    date: f.get("date"),
                    type: f.get("type"),
                    subject: f.get("subject"),
                    attendees: f.get("attendees"),
                    relatedPartNo: f.get("relatedPartNo"),
                    content: f.get("content"),
                    actionItems: f.get("actionItems"),
                    pic: picData // å„²å­˜ Base64 åœ–ç‰‡è³‡æ–™
                };

                if (edit) {
                    updateProject(p => ({ ...p, meetings: (p.meetings || []).map(m => m.id === item.id ? item : m) }));
                } else {
                    updateProject(p => ({ ...p, meetings: [...(p.meetings || []), item] }));
                }
                setIsOpen(false);
                setEdit(null);
                setPicPreview("");
            };

            return (
                <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                    <div className="p-4 bg-gray-50 border-b flex justify-between items-center">
                        <h3 className="font-bold text-gray-700"><i className="fas fa-comments mr-2"></i>5. æœƒè­°ç´€éŒ„ç®¡ç†</h3>
                        <button onClick={() => { setEdit(null); setIsOpen(true); }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md text-sm">
                            <i className="fas fa-plus mr-1"></i> æ–°å¢ç´€éŒ„
                        </button>
                    </div>
                    <div className="divide-y divide-gray-100">
                        {(project.meetings || []).map(m => (
                            <div key={m.id} className="p-6 hover:bg-gray-50 transition">
                                <div className="flex justify-between items-start mb-3">
                                    <div>
                                        <span className="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded mr-2 font-bold">{m.type}</span>
                                        <span className="text-gray-500 text-sm">{m.date}</span>
                                        <h4 className="text-lg font-bold text-gray-800 mt-1">{m.subject}</h4>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => { setEdit(m); setIsOpen(true); }} className="p-2 text-blue-600 hover:bg-blue-50 rounded"><i className="fas fa-edit"></i></button>
                                        <button onClick={() => updateProject(p => ({ ...p, meetings: p.meetings.filter(x => x.id !== m.id) }))} className="p-2 text-red-500 hover:bg-red-50 rounded"><i className="fas fa-trash-alt"></i></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div className="bg-gray-50 p-3 rounded">
                                        <div className="text-gray-500 mb-1"><i className="fas fa-users mr-1"></i> å‡ºå¸­äººå“¡</div>
                                        <div className="text-gray-700">{m.attendees}</div>
                                        <div className="text-gray-500 mt-2 mb-1"><i className="fas fa-link mr-1"></i> é—œè¯éƒ¨å“</div>
                                        <div className="text-blue-600 font-medium">{m.relatedPartNo || "ç„¡"}</div>
                                    </div>
                                    <div className="bg-amber-50 p-3 rounded border-l-4 border-amber-400">
                                        <div className="text-amber-700 font-bold mb-1"><i className="fas fa-exclamation-circle mr-1"></i> å¾…è¾¦/çµè«– (Action Items)</div>
                                        <div className="text-gray-700 whitespace-pre-line">{m.actionItems}</div>
                                    </div>
                                </div>
                                <div className="mt-4 text-gray-600 text-sm border-t pt-3">
                                    <div className="font-bold mb-1 underline">æœƒè­°å…§å®¹æ‘˜è¦ï¼š</div>
                                    <div className="whitespace-pre-line leading-relaxed">{m.content}</div>
                                </div>

                                {/* é¡¯ç¤ºæœƒè­°ç…§ç‰‡ */}
                                {m.pic && (
                                    <div className="mt-3">
                                        <img src={m.pic} alt="æœƒè­°ç…§ç‰‡" 
                                            onClick={() => setSelectedImg(m.pic)}
                                            className="w-48 h-auto rounded shadow-sm cursor-pointer hover:opacity-90 transition"/>
                                        <p className="text-xs text-gray-400 mt-1 italic">é»æ“Šåœ–ç‰‡å¯æ”¾å¤§</p>
                                    </div>
                                )}

                                {/* åœ–ç‰‡æ”¾å¤§æª¢è¦– Modal */}
                                {selectedImg && (
                                    <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60]" onClick={() => setSelectedImg(null)}>
                                        <div className="relative max-w-4xl max-h-[90vh] p-2 bg-white rounded-lg shadow-2xl" onClick={e => e.stopPropagation()}>
                                            <button onClick={() => setSelectedImg(null)} className="absolute -top-10 -right-10 text-white text-3xl hover:text-gray-300">
                                                <i className="fas fa-times"></i>
                                            </button>
                                            <img src={selectedImg} alt="æ”¾å¤§" className="max-w-full max-h-[80vh] block mx-auto rounded"/>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}
                        {(!project.meetings || project.meetings.length === 0) && <div className="text-center py-12 text-gray-400">ç›®å‰å°šç„¡æœƒè­°ç´€éŒ„</div>}
                    </div>

                    {/* æ–°å¢/ç·¨è¼¯ Modal */}
                    {isOpen && (
                        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                            <div className="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                                <h3 className="text-xl font-bold mb-4">{edit ? "ç·¨è¼¯" : "æ–°å¢"}æœƒè­°ç´€éŒ„</h3>
                                <form onSubmit={save} className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium">æ—¥æœŸ</label><input type="date" name="date" defaultValue={edit?.date || new Date().toISOString().split('T')[0]} className="w-full border rounded p-2" required/></div>
                                        <div>
                                            <label className="block text-sm font-medium">é¡å‹</label>
                                            <select name="type" defaultValue={edit?.type || "ä¾‹è¡Œé€±æœƒ"} className="w-full border rounded p-2">
                                                <option>ä¾‹è¡Œé€±æœƒ</option><option>è©¦æ¨¡æª¢è¨</option><option>å“è³ªç•°å¸¸æœƒ</option><option>è¨­è¨ˆè®Šæ›´æœƒ</option><option>å…¶ä»–</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div><label className="block text-sm font-medium">æœƒè­°ä¸»é¡Œ</label><input name="subject" defaultValue={edit?.subject} className="w-full border rounded p-2" placeholder="ä¾‹ï¼šModel-X å…§é£¾ä»¶é€²åº¦ç¢ºèª" required/></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block text-sm font-medium">å‡ºå¸­äººå“¡</label><input name="attendees" defaultValue={edit?.attendees} className="w-full border rounded p-2" placeholder="å¤šä½è«‹ç”¨é€—è™Ÿéš”é–‹"/></div>
                                        <div>
                                            <label className="block text-sm font-medium">é—œè¯éƒ¨å“</label>
                                            <select name="relatedPartNo" defaultValue={edit?.relatedPartNo} className="w-full border rounded p-2">
                                                <option value="">ç„¡é—œè¯</option>
                                                {project.parts.map(p => <option key={p.id} value={p.no}>{p.no} {p.name}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div><label className="block text-sm font-medium">æœƒè­°å…§å®¹æ‘˜è¦</label><textarea name="content" defaultValue={edit?.content} rows="5" className="w-full border rounded p-2" placeholder="è«‹åˆ—å‡ºæœƒè­°è¨è«–é‡é»..."></textarea></div>
                                    
                                    {/* åœ–ç‰‡ä¸Šå‚³é è¦½å€ */}
                                    <div>
                                        <label className="block text-sm font-medium">ä¸Šå‚³æœƒè­°ç…§ç‰‡ / ç´€éŒ„åœ–</label>
                                        <input type="file" name="meetingPic" accept="image/*" 
                                            onChange={(e) => {
                                                if (e.target.files[0]) {
                                                    const r = new FileReader();
                                                    r.onload = (ev) => setPicPreview(ev.target.result);
                                                    r.readAsDataURL(e.target.files[0]);
                                                }
                                            }}
                                            className="w-full border rounded p-2 text-sm"/>
                                        {picPreview && (
                                            <img src={picPreview} alt="é è¦½" className="mt-2 w-32 h-20 object-cover rounded border shadow-sm"/>
                                        )}
                                    </div>

                                    <div><label className="block text-sm font-medium text-amber-700 font-bold">å¾…è¾¦äº‹é … (Action Items)</label><textarea name="actionItems" defaultValue={edit?.actionItems} rows="3" className="w-full border border-amber-300 rounded p-2 bg-amber-50" placeholder="èª°è² è²¬ï¼Ÿä½•æ™‚å®Œæˆï¼Ÿ"></textarea></div>
                                    <div className="flex justify-end gap-3 pt-4 border-t">
                                        <button type="button" onClick={() => {setIsOpen(false); setEdit(null);}} className="px-4 py-2 text-gray-600">å–æ¶ˆ</button>
                                        <button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700">å„²å­˜ç´€éŒ„</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // ===== Dashboard å„€è¡¨æ¿çµ„ä»¶ =====
        const Dashboard = ({ projects, setCurrentId, setActiveView, setActiveTab }) => {

        return (
        <div className="space-y-6">
            <h1 className="text-2xl font-bold mb-4">
                ğŸ“Š å°ˆæ¡ˆç¸½è¦½ Dashboard
            </h1>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* éæ­·æ‰€æœ‰å°ˆæ¡ˆä¸¦é¡¯ç¤ºå¡ç‰‡ */}
                {Object.entries(projects).map(([id, p]) => {
                    const prog = calcProjectProgress(p); // è¨ˆç®—é€²åº¦

                    // TAB1 è¨ˆç®—è©³ç´°åˆ†é¡
                    const totalParts = p.parts.length;
                    const submitted = p.parts.filter(part => part.date).length;
                    const pendingSubmit = totalParts - submitted; // å¾…é€æª¢
                    const qualified = p.parts.filter(part => part.result === "åˆæ ¼").length; // åˆæ ¼
                    const ng = p.parts.filter(part => part.result === "NG").length; // NG
                    const measured = qualified + ng;
                    const pendingVerify = submitted - measured; // å¾…é©—

                    const psPercent = (pendingSubmit / totalParts) * 100 || 0;
                    const qPercent = (qualified / totalParts) * 100 || 0;
                    const ngPercent = (ng / totalParts) * 100 || 0;
                    const pvPercent = (pendingVerify / totalParts) * 100 || 0;

                    let start1 = 0;
                    const pie1 = `conic-gradient(
                        #e5e7eb ${start1}% ${start1 += psPercent}%,
                        #22c55e ${start1}% ${start1 += qPercent}%,
                        #ef4444 ${start1}% ${start1 += ngPercent}%,
                        #3b82f6 ${start1}% 100%
                    )`;

                    // TAB2 è¨ˆç®—è©³ç´°åˆ†é¡
                    const docKeys = ["drawing", "bubble", "eval", "cp", "sip", "sop"];
                    let docDone = 0;
                    let docTotal = 0;
                    p.parts.forEach(part => {
                        const d = p.docs[part.id] || {};
                        docKeys.forEach(k => {
                            docTotal++;
                            if (d[k] === 2) docDone++;
                        });
                    });
                    const donePercent2 = (docDone / docTotal) * 100 || 0;
                    const undonePercent2 = 100 - donePercent2;
                    const pie2 = `conic-gradient(
                        #22c55e 0% ${donePercent2}%,
                        #e5e7eb ${donePercent2}% 100%
                    )`;

                    // TAB3 è¨ˆç®—è©³ç´°åˆ†é¡
                    const issues = p.issues || [];
                    const solved = issues.filter(i => i.result === "æœ‰æ•ˆ").length;
                    const solvedPercent3 = (solved / issues.length) * 100 || 0;
                    const unsolvedPercent3 = 100 - solvedPercent3;
                    const pie3 = `conic-gradient(
                        #22c55e 0% ${solvedPercent3}%,
                        #e5e7eb ${solvedPercent3}% 100%
                    )`;

                    return (
                        <div
                            key={id}
                            onClick={() => {
                                // é»æ“Šå¡ç‰‡è·³è½‰è‡³è©²å°ˆæ¡ˆ
                                setCurrentId(id);
                                setActiveView("project");
                                setActiveTab("tab1");
                            }}
                            className="bg-white rounded-xl p-6 shadow border cursor-pointer hover:ring-2 hover:ring-blue-400"
                        >
                            <div className="font-bold text-lg mb-3">
                                {p.info.model}
                            </div>

                            

                            {/*é¡¯ç¤ºå„é …é€²åº¦æ•¸å€¼+ åœ“é¤…åœ–è¦–è¦ºåŒ– */}
                            <div className="mt-4 space-y-2">
                                <div className="flex items-center gap-2">
                                    <div>ğŸ”¹ éƒ¨å“é€æ¨£ï¼ˆTAB1ï¼‰ï¼š{prog.tab1}%</div>
                                    <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: pie1 }}></div>
                                    
                                </div>
                                <div className="flex items-center gap-2">
                                    <div>ğŸ”¹ PPAP æ–‡ä»¶ï¼ˆTAB2ï¼‰ï¼š{prog.tab2}%</div>
                                    <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: pie2 }}></div>
                                    
                                </div>
                                <div className="flex items-center gap-2">
                                    <div>ğŸ”¹ å•é¡Œé»å°æ‡‰ï¼ˆTAB3ï¼‰ï¼š{prog.tab3}%</div>
                                    <div style={{ width: '40px', height: '40px', borderRadius: '50%', background: pie3 }}></div>
                                    
                                </div>
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
};
        

        // ===== ä¸»æ‡‰ç”¨ç¨‹å¼çµ„ä»¶ (App) =====
        const App = () => {
            // æ§åˆ¶æ˜¯å¦é¡¯ç¤ºå‚™ä»½æé†’
            const [showBackupReminder, setShowBackupReminder] = useState(false);

            // å°ˆæ¡ˆè³‡æ–™ State
            const [projects, setProjects] = useState(demoProjects);
            // ç•¶å‰é¸ä¸­çš„å°ˆæ¡ˆ ID
            const [currentId, setCurrentId] = useState(null);
            // ç•¶å‰é¸ä¸­çš„åˆ†é  (Tab)
            const [activeTab, setActiveTab] = useState("tab1");
            // ç•¶å‰è¦–åœ– (Project Detail æˆ– Dashboard)
            const [activeView, setActiveView] = useState("project"); 
            // å´é‚Šæ¬„ç¸®æ”¾ç‹€æ…‹
            const [sidebarCollapsed, setSidebarCollapsed] = useState(false);

            // åˆå§‹åŒ–ï¼šå¾ IndexedDB è®€å–è³‡æ–™
            useEffect(() => {
                (async () => {
                    const saved = await idbGet("qa-projects");
                    if (saved) setProjects(saved);
                })();
            }, []);

            // ç›£è½ projects è®ŠåŒ–ï¼šè‡ªå‹•å­˜å…¥ IndexedDB èˆ‡ LocalStorage ç´€éŒ„
            useEffect(() => {
                // v1 ç›¸å®¹æ¨¡å¼å­˜æª”
                idbSet("qa-projects", projects);

                // v2 æ¶æ§‹ï¼šä¹Ÿå¯å°‡å°ˆæ¡ˆæ‹†é–‹å„²å­˜ (å‚™ç”¨)
                Object.entries(projects).forEach(([id, project]) => {
                    idbSet(`project:${id}`, project);
                });

                // æ›´æ–°æœ€å¾Œä¿®æ”¹æ™‚é–“
                idbSet("qa-last-modified", Date.now());
                localStorage.setItem("qa-last-modified", Date.now());
            }, [projects]);

            // ç•¶æ²’æœ‰é¸ä¸­å°ˆæ¡ˆä¸”æœ‰å°ˆæ¡ˆå­˜åœ¨æ™‚ï¼Œé è¨­é¸å–ç¬¬ä¸€å€‹
            useEffect(() => {
                if (!currentId && Object.keys(projects).length > 0) {
                    setCurrentId(Object.keys(projects)[0]);
                }
            }, [projects]);

            // æª¢æŸ¥æ˜¯å¦éœ€è¦å‚™ä»½ (ä¿®æ”¹æ™‚é–“ > å‚™ä»½æ™‚é–“)
            useEffect(() => {
                (async () => {
                    const lastModified = (await idbGet("qa-last-modified")) || 0;
                    const lastBackup = (await idbGet("qa-last-backup")) || 0;

                    if (lastModified > lastBackup) {
                        setShowBackupReminder(true);
                    }
                })();
            }, []);
            
            // è¦–çª—é—œé–‰å‰è­¦å‘Š (è‹¥æœªå‚™ä»½)
            useEffect(() => {
                const handler = (e) => {
                    const lastModified = Number(localStorage.getItem("qa-last-modified") || 0);
                    const lastBackup = Number(localStorage.getItem("qa-last-backup") || 0);
                    if (lastModified > lastBackup) {
                        e.preventDefault();
                        e.returnValue = "é›¢é–‹å‰æ˜¯å¦å·²åŒ¯å‡ºå‚™ä»½ï¼Ÿ";
                    }
                };
                window.addEventListener("beforeunload", handler);
                return () => window.removeEventListener("beforeunload", handler);
            }, []);

            // å–å¾—ç•¶å‰å°ˆæ¡ˆè³‡æ–™ç‰©ä»¶
            const current = projects[currentId] || { info: {}, parts: [], docs: {}, issues: [], tasks: [] };
            
            // æ›´æ–°ç•¶å‰å°ˆæ¡ˆçš„è¼”åŠ©å‡½å¼
            const updateCurrent = (fn) => {
                setProjects(p => ({ ...p, [currentId]: fn(p[currentId]) }));
            };

            // è¼‰å…¥ä¸­ç‹€æ…‹è™•ç†
            if (activeView === "project" && !currentId) {
                return (
                    <div className="flex items-center justify-center h-screen text-xl text-gray-500">
                        è¼‰å…¥ä¸­â€¦
                    </div>
                );
            }

            return (
                <div className="flex h-screen overflow-hidden">
                    {/* å·¦å´é¸å–® */}
                    <Sidebar
                        currentProjectId={currentId}
                        setCurrentProjectId={setCurrentId}
                        projects={projects}
                        setProjects={setProjects}
                        setCurrentId={setCurrentId}
                        collapsed={sidebarCollapsed}
                        setCollapsed={setSidebarCollapsed}
                        setActiveView={setActiveView}
                    />
                    
                    {/* å³å´ä¸»å…§å®¹å€ */}
                    <div className={`flex-1 ${sidebarCollapsed ? "ml-20" : "ml-72"} p-8 overflow-y-auto pdf-export-area transition-all duration-300`}>
                        
                        {/* ===== PDF åŒ¯å‡ºå°ˆç”¨éš±è—å€ (å®Œæ•´æ¸²æŸ“æ‰€æœ‰ Tabs ç”Ÿæˆå ±å‘Š) ===== */}
<div className="pdf-export-hidden pdf-export-area">
    {/* 0. å°ˆæ¡ˆå°é¢/æ¨™é ­ */}
    <div className="mb-8 text-center border-b-2 border-gray-800 pb-4">
        <h1 className="text-4xl font-bold mb-2">QA å°ˆæ¡ˆç®¡ç†å ±å‘Š</h1>
        <p className="text-gray-500">åŒ¯å‡ºæ—¥æœŸï¼š{new Date().toLocaleDateString()}</p>
    </div>
    <ProjectHeader project={current} />

    {/* 1. éƒ¨å“é€æ¨£æ¸…å–® */}
    <div className="pdf-section-title">1. éƒ¨å“é€æ¨£æ¸…å–®</div>
    {/* æ³¨æ„ï¼šé€™è£¡å‚³å…¥ dummy updateProject é¿å…åœ¨ PDF é è¦½å€èª¤è§¸ç™¼æ›´æ–° */}
    <Tab1_Submission project={current} updateProject={() => {}} />
    
    <div className="pdf-page-break"></div>

    {/* 2. PPAP æ–‡ä»¶ç‹€æ³ */}
    <div className="pdf-section-title">2. PPAP æ–‡ä»¶çŸ©é™£</div>
    <Tab2_Docs project={current} updateProject={() => {}} />

    <div className="pdf-page-break"></div>

    {/* 3. å•é¡Œé»è¿½è¹¤ */}
    <div className="pdf-section-title">3. å•é¡Œé»è¿½è¹¤è¡¨</div>
    <Tab3_Issues project={current} updateProject={() => {}} />

    <div className="pdf-page-break"></div>

    {/* 4. æœƒè­°ç´€éŒ„ (é¸æ“‡æ€§åŒ¯å‡º) */}
    <div className="pdf-section-title">4. æœƒè­°ç´€éŒ„æ‘˜è¦</div>
    <Tab5_Meetings project={current} updateProject={() => {}} />
    
    {/* é å°¾è²æ˜ */}
    <div className="mt-10 text-center text-xs text-gray-400 border-t pt-4">
        æœ¬å ±è¡¨ç”± QA PMS ç³»çµ±è‡ªå‹•ç”¢ç”Ÿ
    </div>

</div>

                        {/* æ ¹æ“šè¦–åœ–æ¨¡å¼é¡¯ç¤ºå…§å®¹ */}
                        {activeView === "dashboard" ? (
                            <Dashboard 
                                projects={projects} 
                                setCurrentId={setCurrentId} 
                                setActiveView={setActiveView} 
                                setActiveTab={setActiveTab} />
                        ) : (
                            <>
                                {/* å°ˆæ¡ˆæ¨™é ­ */}
                                <ProjectHeader project={current} />

                                {/* Tab åˆ‡æ›æŒ‰éˆ• */}
                                <div className="mb-6">
                                    <div className="flex gap-4 border-b">
                                        {[
                                            { id: "tab1", icon: "fa-box-open", label: "1. éƒ¨å“é€æ¨£" },
                                            { id: "tab2", icon: "fa-file-contract", label: "2. PPAP æ–‡ä»¶" },
                                            { id: "tab3", icon: "fa-bug", label: "3. å•é¡Œé»è¿½è¹¤" },
                                            { id: "tab4", icon: "fa-list-check", label: "4. å…¶ä»–ä»»å‹™" },
                                            { id: "tab5", icon: "fa-comments", label: "5. æœƒè­°ç´€éŒ„" },
                                        ].map(t => (
                                            <button
                                                key={t.id}
                                                onClick={() => setActiveTab(t.id)}
                                                className={`px-6 py-3 font-medium transition ${activeTab === t.id ? "text-blue-600 border-b-4 border-blue-600" : "text-gray-600 hover:text-gray-900"}`}
                                            >
                                                <i className={`fas ${t.icon} mr-2`}></i>{t.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                {/* æ ¹æ“š Tab é¡¯ç¤ºå°æ‡‰çµ„ä»¶ */}
                                {activeTab === "tab1" && <Tab1_Submission project={current} updateProject={updateCurrent} />}
                                {activeTab === "tab2" && <Tab2_Docs project={current} updateProject={updateCurrent} />}
                                {activeTab === "tab3" && <Tab3_Issues project={current} updateProject={updateCurrent} />}
                                {activeTab === "tab4" && <Tab4_Tasks project={current} updateProject={updateCurrent} />}
                                {activeTab === "tab5" && <Tab5_Meetings project={current} updateProject={updateCurrent} />}
                            </>
                        )}
                    </div>

                    {/* å‚™ä»½æé†’ Modal */}
                    {showBackupReminder && (
                        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
                            <div className="bg-white rounded-xl p-6 w-[360px] shadow-lg">
                                <h3 className="text-lg font-semibold mb-2">
                                    å°šæœªå‚™ä»½è³‡æ–™
                                </h3>
                                <p className="text-sm text-gray-600 mb-4">
                                    åµæ¸¬åˆ°è³‡æ–™åœ¨ä¸Šæ¬¡å‚™ä»½å¾Œæœ‰ç•°å‹•ï¼Œå»ºè­°ç«‹å³åŒ¯å‡º JSON å‚™ä»½ã€‚
                                </p>
                                <div className="flex justify-end gap-3">
                                    <button
                                        onClick={() => setShowBackupReminder(false)}
                                        className="px-4 py-2 text-gray-600 hover:text-gray-800"
                                    >
                                        ç¨å¾Œå†èªª
                                    </button>
                                    <button
                                        onClick={() => {
                                            exportJSONBackup(projects);
                                            setShowBackupReminder(false);
                                        }}
                                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                                    >
                                        ç«‹å³å‚™ä»½
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        // React å•Ÿå‹•é»
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>