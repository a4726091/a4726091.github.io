<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ZETTL // 卡片盒核心系統</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts: JetBrains Mono (Code/Tech feel) & Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            tech: {
              bg: '#0f172a',      // Dark slate background
              panel: '#1e293b',   // Lighter panel
              border: '#334155',  // Border color
              accent: '#06b6d4',  // Cyan neon
              secondary: '#6366f1', // Indigo
              success: '#10b981', // Emerald
              danger: '#ef4444',  // Red
            }
          },
          boxShadow: {
            'neon': '0 0 5px theme("colors.tech.accent"), 0 0 10px theme("colors.tech.accent")',
            'neon-green': '0 0 5px theme("colors.tech.success"), 0 0 10px theme("colors.tech.success")',
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #475569; }

    /* Content Editable Placeholder */
    [contenteditable]:empty:before {
      content: attr(placeholder);
      color: #64748b;
      cursor: text;
    }

    /* Editor Images */
    .editor-content img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #334155;
      margin: 10px 0;
    }
    .editor-content img.resizable {
      box-shadow: 0 0 0 2px #06b6d4;
    }
    
    /* Layout Transitions */
    .sidebar-transition {
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* Mobile State: Hidden off-canvas */
    .mobile-hidden-left { transform: translateX(-100%); }
    .mobile-hidden-right { transform: translateX(100%); }
    
    /* Desktop State: Collapsed width */
    .desktop-collapsed { width: 0 !important; overflow: hidden; opacity: 0; }
    
    /* Glassmorphism */
    .glass-panel {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
  </style>
</head>
<body class="bg-tech-bg text-slate-200 font-sans h-[100dvh] w-screen overflow-hidden flex relative">

  <!-- Mobile Backdrop (Click to close sidebars) -->
  <div id="backdrop" onclick="closeAllMobilePanels()" class="fixed inset-0 bg-black/60 z-30 hidden md:hidden backdrop-blur-sm transition-opacity"></div>

  <!-- Notification Toast Area -->
  <div id="toast-container" class="fixed top-5 right-5 z-[60] flex flex-col gap-2 pointer-events-none"></div>

  <!-- LEFT SIDEBAR (Navigation) -->
  <aside id="sidebar-left" class="sidebar-transition fixed md:relative inset-y-0 left-0 z-40 w-[85vw] md:w-80 bg-tech-panel border-r border-tech-border flex flex-col mobile-hidden-left md:transform-none shadow-2xl md:shadow-none h-full">
    
    <!-- Header -->
    <div class="p-4 border-b border-tech-border flex items-center justify-between shrink-0 bg-tech-panel">
      <div class="flex items-center gap-2 text-tech-accent">
        <i class="fa-solid fa-microchip text-xl"></i>
        <h1 class="font-mono text-lg font-bold tracking-wider">ZETTEL_CORE</h1>
      </div>
      <div class="flex gap-3">
        <button onclick="saveNotes()" class="text-slate-400 hover:text-tech-accent transition p-1"><i class="fa-solid fa-floppy-disk"></i></button>
        <label for="import-notes" class="text-slate-400 hover:text-tech-accent transition cursor-pointer p-1"><i class="fa-solid fa-file-import"></i></label>
        <input type="file" id="import-notes" accept=".json" class="hidden" onchange="importNotes()" />
        <!-- Close button for mobile -->
        <button onclick="togglePanel('left')" class="md:hidden text-slate-400 hover:text-white p-1"><i class="fa-solid fa-times"></i></button>
      </div>
    </div>

    <!-- Search -->
    <div class="p-3 border-b border-tech-border bg-slate-800/50 shrink-0">
      <div class="relative mb-2">
        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
        <input type="text" id="search-input" placeholder="搜尋..." 
               class="w-full bg-slate-900 border border-slate-700 rounded text-sm px-8 py-2 focus:border-tech-accent focus:outline-none text-slate-200">
      </div>
      <select id="tag-filter" onchange="filterNotes()" class="w-full bg-slate-900 border border-slate-700 rounded text-sm px-2 py-1.5 text-slate-300 outline-none">
        <option value="">所有標籤</option>
      </select>
    </div>

    <!-- Note List -->
    <div id="note-list" class="flex-1 overflow-y-auto p-2 space-y-2 pb-20 md:pb-2">
      <!-- Items generated by JS -->
    </div>

    <!-- Footer Action (Create) -->
    <div class="p-4 border-t border-tech-border bg-tech-panel shrink-0 sticky bottom-0 z-10 pb-6 md:pb-4">
      <button onclick="createNewNote()" class="w-full bg-tech-accent/10 border border-tech-accent text-tech-accent hover:bg-tech-accent hover:text-slate-900 font-mono py-3 rounded shadow-neon flex items-center justify-center gap-2 font-bold transition-all active:scale-95">
        <i class="fa-solid fa-plus"></i> 建立新資料卡
      </button>
    </div>
  </aside>


  <!-- MAIN CONTENT (Editor) -->
  <main class="flex-1 flex flex-col h-full relative min-w-0 bg-tech-bg bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')]">
    
    <!-- Top Bar -->
    <header class="h-16 border-b border-tech-border glass-panel flex items-center justify-between px-4 shrink-0 z-20">
      <div class="flex items-center gap-3 w-full overflow-hidden">
        <button onclick="togglePanel('left')" class="text-slate-400 hover:text-white p-2 rounded hover:bg-slate-700/50 shrink-0">
            <i class="fa-solid fa-bars text-lg"></i>
        </button>
        <input type="text" id="note-title" placeholder="輸入標題..." 
               class="bg-transparent border-none text-lg md:text-xl font-bold text-white placeholder-slate-600 focus:outline-none w-full font-mono truncate" />
      </div>
      
      <div class="flex items-center gap-1 shrink-0">
        <button onclick="deleteCurrentNote()" id="btn-delete" class="hidden text-red-500 hover:bg-red-500/10 p-2 rounded mx-1" title="刪除">
          <i class="fa-solid fa-trash-can"></i>
        </button>
        <div class="h-6 w-px bg-slate-700 mx-1"></div>
        <button onclick="togglePanel('right')" class="text-tech-secondary hover:text-white p-2 rounded hover:bg-slate-700/50 relative">
            <i class="fa-solid fa-sliders text-lg"></i>
            <!-- Dot indicator for metadata -->
            <span class="absolute top-2 right-2 w-2 h-2 bg-tech-secondary rounded-full animate-pulse"></span>
        </button>
      </div>
    </header>

    <!-- Formatting Toolbar -->
    <div class="px-4 py-2 border-b border-tech-border bg-slate-800/40 flex items-center gap-2 overflow-x-auto whitespace-nowrap shrink-0 no-scrollbar">
      <div class="flex bg-slate-900 rounded border border-slate-700 p-0.5">
        <button onclick="formatText('bold')" class="p-2 px-3 text-slate-300 hover:text-white"><i class="fa-solid fa-bold"></i></button>
        <button onclick="formatText('italic')" class="p-2 px-3 text-slate-300 hover:text-white"><i class="fa-solid fa-italic"></i></button>
        <button onclick="formatText('underline')" class="p-2 px-3 text-slate-300 hover:text-white"><i class="fa-solid fa-underline"></i></button>
      </div>
      <select id="fontSizeSelect" onchange="changeFontSize(this.value)" class="bg-slate-900 border border-slate-700 text-slate-300 rounded p-2 text-sm outline-none">
        <option value="3">文字大小</option>
        <option value="4">標題 M</option>
        <option value="6">標題 L</option>
      </select>
      <label class="cursor-pointer bg-slate-900 border border-slate-700 text-slate-300 rounded p-2 px-3 text-sm flex items-center gap-2">
        <i class="fa-regular fa-image"></i>
        <input type="file" id="imageUpload" accept="image/*" onchange="insertImage(this)" class="hidden">
      </label>
    </div>

    <!-- Editor Area -->
    <div class="flex-1 overflow-y-auto p-4 md:p-8">
      <div id="editor-content" class="editor-content w-full min-h-[50vh] outline-none text-slate-300 leading-relaxed text-lg pb-20" 
           contenteditable="true" placeholder="在此輸入內容..."></div>
    </div>
  </main>


  <!-- RIGHT SIDEBAR (Metadata) -->
  <aside id="sidebar-right" class="sidebar-transition fixed md:relative inset-y-0 right-0 z-40 w-[85vw] md:w-72 bg-tech-panel border-l border-tech-border flex flex-col mobile-hidden-right md:transform-none shadow-2xl md:shadow-none h-full">
    
    <!-- Mobile Header for Right Panel -->
    <div class="md:hidden p-4 border-b border-tech-border flex justify-between items-center shrink-0">
        <span class="text-tech-secondary font-bold font-mono"><i class="fa-solid fa-sliders mr-2"></i>資料屬性</span>
        <button onclick="togglePanel('right')" class="text-slate-400 p-1"><i class="fa-solid fa-times"></i></button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto p-4 space-y-6 pb-24 md:pb-4">
      
      <!-- Tags -->
      <div>
        <h3 class="text-xs font-mono text-tech-accent mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
          <i class="fa-solid fa-tags mr-1"></i> 標籤系統
        </h3>
        <div class="flex gap-2 mb-2">
          <input type="text" id="tag-input" placeholder="新標籤..." class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-2 text-sm focus:border-tech-accent outline-none">
          <button onclick="addTag()" class="bg-slate-700 text-white px-3 rounded"><i class="fa-solid fa-plus"></i></button>
        </div>
        <select id="tag-history" onchange="addTagFromHistory(this)" class="w-full bg-slate-800 border-none text-xs text-slate-400 p-2 rounded mb-2">
           <option value="">+ 歷史標籤</option>
        </select>
        <div id="active-tags" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Linked Notes -->
      <div>
        <h3 class="text-xs font-mono text-tech-secondary mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
          <i class="fa-solid fa-link mr-1"></i> 連結網絡
        </h3>
        <div class="relative mb-2">
           <input list="link-suggestions" id="link-input" placeholder="搜尋筆記..." 
                  class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-2 text-sm focus:border-tech-secondary outline-none">
           <datalist id="link-suggestions"></datalist>
           <button onclick="addLinkedNote()" class="absolute right-2 top-2 text-tech-secondary"><i class="fa-solid fa-plus-circle"></i></button>
        </div>
        <div id="linked-notes-list" class="space-y-2"></div>
      </div>

    </div>

    <!-- Footer Action (Save) -->
    <div class="p-4 border-t border-tech-border bg-tech-panel shrink-0 sticky bottom-0 z-10 pb-6 md:pb-4">
        <button onclick="updateCurrentNote()" id="btn-save-update" class="w-full bg-tech-success/10 border border-tech-success text-tech-success hover:bg-tech-success hover:text-slate-900 py-3 rounded font-mono font-bold text-sm transition shadow-neon-green active:scale-95 flex items-center justify-center">
            <i class="fa-regular fa-floppy-disk mr-2"></i> 保存變更
        </button>
    </div>
  </aside>

  <script>
    // --- Global State ---
    let notes = [];
    let currentNoteId = null;

    // --- DOM Refs ---
    const els = {
      list: document.getElementById('note-list'),
      title: document.getElementById('note-title'),
      content: document.getElementById('editor-content'),
      tagInput: document.getElementById('tag-input'),
      activeTags: document.getElementById('active-tags'),
      linkedList: document.getElementById('linked-notes-list'),
      searchInput: document.getElementById('search-input'),
      sidebarLeft: document.getElementById('sidebar-left'),
      sidebarRight: document.getElementById('sidebar-right'),
      backdrop: document.getElementById('backdrop'),
      btnSave: document.getElementById('btn-save-update'),
      btnDelete: document.getElementById('btn-delete'),
      tagHistory: document.getElementById('tag-history'),
      linkSuggestions: document.getElementById('link-suggestions'),
      tagFilter: document.getElementById('tag-filter'),
      toastContainer: document.getElementById('toast-container')
    };

    // --- Init ---
    window.onload = function() {
      const stored = localStorage.getItem('zettelkasten_notes');
      notes = stored ? JSON.parse(stored) : [{
        id: '1',
        title: '歡迎使用 ZETTEL_CORE',
        content: '<b>開始你的旅程。</b><br><br>這是一個 RWD 優化版本。<br>手機上點擊左上角開啟選單，右上角開啟屬性面板。',
        tags: ['System'], linkedNotes: []
      }];
      
      renderNoteList();
      updateTagHistory();
      renderLinkSuggestions();
      createNewNote();
    };

    // --- Layout Logic (Crucial for Mobile) ---
    function togglePanel(side) {
      const isMobile = window.innerWidth < 768;
      const el = side === 'left' ? els.sidebarLeft : els.sidebarRight;
      const mobileClass = side === 'left' ? 'mobile-hidden-left' : 'mobile-hidden-right';
      
      if (isMobile) {
        // Toggle slide-in class
        const isClosed = el.classList.contains(mobileClass);
        if (isClosed) {
          el.classList.remove(mobileClass);
          els.backdrop.classList.remove('hidden');
        } else {
          el.classList.add(mobileClass);
          // Only hide backdrop if BOTH are closed
          if (els.sidebarLeft.classList.contains('mobile-hidden-left') && 
              els.sidebarRight.classList.contains('mobile-hidden-right')) {
            els.backdrop.classList.add('hidden');
          }
        }
      } else {
        // Desktop collapse
        el.classList.toggle('desktop-collapsed');
      }
    }

    function closeAllMobilePanels() {
      els.sidebarLeft.classList.add('mobile-hidden-left');
      els.sidebarRight.classList.add('mobile-hidden-right');
      els.backdrop.classList.add('hidden');
    }

    // --- Core Logic ---
    function genId() { return Date.now().toString(36) + Math.random().toString(36).substr(2); }

    function createNewNote() {
      currentNoteId = null;
      els.title.value = '';
      els.content.innerHTML = '';
      els.btnDelete.classList.add('hidden');
      els.btnSave.innerHTML = '<i class="fa-solid fa-plus mr-2"></i> 建立新筆記';
      
      renderTagsUI([]);
      renderLinkedUI([]);
      
      document.querySelectorAll('.note-item').forEach(el => el.classList.remove('border-tech-accent', 'bg-slate-800'));
      
      // On mobile, close sidebar after clicking create
      if (window.innerWidth < 768) closeAllMobilePanels();
    }

    function loadNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;

      currentNoteId = note.id;
      els.title.value = note.title;
      els.content.innerHTML = note.content;
      els.btnDelete.classList.remove('hidden');
      els.btnSave.innerHTML = '<i class="fa-regular fa-floppy-disk mr-2"></i> 保存變更';

      renderTagsUI(note.tags || []);
      renderLinkedUI(note.linkedNotes || []);
      
      document.querySelectorAll('.note-item').forEach(el => {
        el.classList.remove('border-tech-accent', 'bg-slate-800');
        if(el.dataset.id === id) el.classList.add('border-tech-accent', 'bg-slate-800');
      });

      setTimeout(() => document.querySelectorAll('img').forEach(makeImageResizable), 100);
      
      // On mobile, close sidebar after selection
      if (window.innerWidth < 768) closeAllMobilePanels();
    }

    function updateCurrentNote() {
      const title = els.title.value.trim();
      const content = els.content.innerHTML;
      if (!title) return showToast('標題不能為空', 'error');

      const tags = Array.from(els.activeTags.querySelectorAll('span:first-child')).map(s => s.textContent);
      const links = Array.from(els.linkedList.querySelectorAll('.link-card')).map(d => d.dataset.id);

      if (currentNoteId) {
        const idx = notes.findIndex(n => n.id === currentNoteId);
        if (idx !== -1) notes[idx] = { ...notes[idx], title, content, tags, linkedNotes: links };
        showToast('已更新', 'success');
      } else {
        const newId = genId();
        notes.push({ id: newId, title, content, tags, linkedNotes: links });
        currentNoteId = newId;
        // Backlink logic
        links.forEach(lid => {
           const t = notes.find(n => n.id === lid);
           if(t && !t.linkedNotes.includes(newId)) t.linkedNotes.push(newId);
        });
        showToast('已建立', 'success');
        els.btnDelete.classList.remove('hidden');
        els.btnSave.innerHTML = '<i class="fa-regular fa-floppy-disk mr-2"></i> 保存變更';
      }
      
      saveStorage();
      renderNoteList();
      updateTagHistory();
      renderLinkSuggestions();
      // On mobile, close right sidebar after save
      if (window.innerWidth < 768) closeAllMobilePanels();
    }

    function deleteCurrentNote() {
      if (!currentNoteId || !confirm('確定刪除？')) return;
      notes = notes.filter(n => n.id !== currentNoteId);
      // Remove backlinks
      notes.forEach(n => { n.linkedNotes = n.linkedNotes.filter(id => id !== currentNoteId); });
      saveStorage();
      renderNoteList();
      createNewNote();
      showToast('已刪除', 'info');
    }

    // --- Renderers ---
    function renderNoteList() {
      const txt = els.searchInput.value.toLowerCase();
      const tag = els.tagFilter.value;
      els.list.innerHTML = '';
      
      notes.filter(n => 
        (n.title.toLowerCase().includes(txt) || n.content.toLowerCase().includes(txt)) &&
        (!tag || (n.tags||[]).includes(tag))
      ).forEach(n => {
        const div = document.createElement('div');
        div.className = 'note-item p-3 border-l-2 border-transparent hover:bg-slate-800 cursor-pointer mb-1 rounded-r transition-colors';
        if (n.id === currentNoteId) div.classList.add('border-tech-accent', 'bg-slate-800');
        div.dataset.id = n.id;
        div.onclick = () => loadNote(n.id);
        div.innerHTML = `<div class="font-bold text-slate-200 truncate">${n.title}</div>
                         <div class="text-xs text-slate-500 truncate">${n.content.replace(/<[^>]*>/g, '')}</div>`;
        els.list.appendChild(div);
      });
    }

    function renderTagsUI(tags) {
      els.activeTags.innerHTML = tags.map(t => `
        <div class="bg-tech-accent/20 border border-tech-accent/40 text-tech-accent px-2 py-1 rounded text-xs flex items-center gap-1">
          <span>${t}</span><button onclick="this.parentElement.remove()" class="hover:text-white ml-1">&times;</button>
        </div>
      `).join('');
    }

    function renderLinkedUI(ids) {
      els.linkedList.innerHTML = '';
      ids.forEach(id => {
        const n = notes.find(x => x.id === id);
        if(!n) return;
        const div = document.createElement('div');
        div.className = 'link-card bg-slate-800 p-2 rounded flex justify-between items-center border border-slate-700 hover:border-tech-secondary cursor-pointer';
        div.dataset.id = id;
        div.innerHTML = `<div onclick="loadNote('${id}')" class="truncate text-sm text-slate-300"><i class="fa-solid fa-link text-xs mr-1"></i>${n.title}</div>
                         <button onclick="this.parentElement.remove()" class="text-slate-500 hover:text-red-400">&times;</button>`;
        els.linkedList.appendChild(div);
      });
    }

    // --- Helpers ---
    function addTag() {
      const t = els.tagInput.value.trim();
      if(!t) return;
      const curr = Array.from(els.activeTags.querySelectorAll('span:first-child')).map(s => s.textContent);
      if(!curr.includes(t)) {
        const temp = document.createElement('div');
        temp.innerHTML = `<div class="bg-tech-accent/20 border border-tech-accent/40 text-tech-accent px-2 py-1 rounded text-xs flex items-center gap-1"><span>${t}</span><button onclick="this.parentElement.remove()" class="hover:text-white ml-1">&times;</button></div>`;
        els.activeTags.appendChild(temp.firstChild);
      }
      els.tagInput.value = '';
    }
    
    function addTagFromHistory(sel) { 
        if(sel.value) { els.tagInput.value = sel.value; addTag(); sel.value = ''; } 
    }

    function addLinkedNote() {
      const val = document.getElementById('link-input').value;
      const target = notes.find(n => n.title === val);
      if(target && target.id !== currentNoteId) {
         const curr = Array.from(els.linkedList.querySelectorAll('.link-card')).map(d => d.dataset.id);
         if(!curr.includes(target.id)) renderLinkedUI([...curr, target.id]);
      }
      document.getElementById('link-input').value = '';
    }

    function updateTagHistory() {
      const all = new Set(notes.flatMap(n => n.tags || []));
      const opts = ['<option value="">所有標籤</option>', ...[...all].map(t => `<option value="${t}">${t}</option>`)];
      els.tagFilter.innerHTML = opts.join('');
      els.tagHistory.innerHTML = ['<option value="">+ 歷史標籤</option>', ...[...all].map(t => `<option value="${t}">${t}</option>`)].join('');
    }

    function renderLinkSuggestions() {
      els.linkSuggestions.innerHTML = notes.map(n => `<option value="${n.title}"></option>`).join('');
    }

    function saveStorage() { localStorage.setItem('zettelkasten_notes', JSON.stringify(notes)); }

    function saveNotes() {
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([JSON.stringify(notes,null,2)], {type:'application/json'}));
      a.download = `zettelkasten_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
    }
    
    function importNotes() {
      const r = new FileReader();
      r.onload = e => {
         try {
           const d = JSON.parse(e.target.result);
           const exist = new Set(notes.map(n => n.id));
           d.forEach(n => { if(!n.id) n.id=genId(); if(!exist.has(n.id)) notes.push(n); });
           saveStorage(); renderNoteList(); updateTagHistory(); renderLinkSuggestions();
           showToast('導入成功', 'success');
         } catch(e) { showToast('格式錯誤', 'error'); }
      };
      if(document.getElementById('import-notes').files[0]) r.readAsText(document.getElementById('import-notes').files[0]);
    }

    // Editor Utils
    function formatText(cmd) { document.execCommand(cmd, false, null); els.content.focus(); }
    function changeFontSize(v) { document.execCommand('fontSize', false, v); els.content.focus(); }
    function insertImage(inp) {
      if(!inp.files[0]) return;
      const r = new FileReader();
      r.onload = e => { 
        els.content.focus(); 
        document.execCommand('insertImage', false, e.target.result);
        setTimeout(() => document.querySelectorAll('img').forEach(makeImageResizable), 100);
      };
      r.readAsDataURL(inp.files[0]);
      inp.value = '';
    }
    function makeImageResizable(img) {
      if(img.dataset.resizable) return;
      img.dataset.resizable = "true";
      img.onclick = (e) => { e.stopPropagation(); document.querySelectorAll('img').forEach(i=>i.classList.remove('resizable')); img.classList.add('resizable'); };
    }
    document.onclick = (e) => { if(!e.target.closest('img')) document.querySelectorAll('img').forEach(i=>i.classList.remove('resizable')); };
    els.searchInput.oninput = renderNoteList;

    function showToast(msg, type) {
      const d = document.createElement('div');
      d.className = `p-3 rounded border shadow-lg flex items-center gap-2 animate-[fadeIn_0.3s] bg-slate-900 ${type==='error'?'border-red-500 text-red-500':'border-tech-accent text-tech-accent'}`;
      d.innerHTML = `<span>${msg}</span>`;
      els.toastContainer.appendChild(d);
      setTimeout(() => d.remove(), 2500);
    }
  </script>
</body>
</html>
