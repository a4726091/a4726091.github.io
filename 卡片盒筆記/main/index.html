<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ZETTL // 卡片盒核心系統 + Gemini AI</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Google Fonts: JetBrains Mono (Code/Tech feel) & Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- FontAwesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            tech: {
              bg: '#0f172a',      // Dark slate background
              panel: '#1e293b',   // Lighter panel
              border: '#334155',  // Border color
              accent: '#06b6d4',  // Cyan neon
              secondary: '#6366f1', // Indigo
              success: '#10b981', // Emerald
              danger: '#ef4444',  // Red
              warning: '#f59e0b', // Amber
            }
          },
          boxShadow: {
            'neon': '0 0 5px theme("colors.tech.accent"), 0 0 10px theme("colors.tech.accent")',
            'neon-red': '0 0 5px theme("colors.tech.danger"), 0 0 10px theme("colors.tech.danger")',
            'neon-green': '0 0 5px theme("colors.tech.success"), 0 0 10px theme("colors.tech.success")',
            'neon-purple': '0 0 5px theme("colors.tech.secondary"), 0 0 10px theme("colors.tech.secondary")',
          },
          animation: {
            'spin-slow': 'spin 3s linear infinite',
            'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar for Webkit */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #0f172a; 
    }
    ::-webkit-scrollbar-thumb {
      background: #334155; 
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #475569; 
    }

    /* Content Editable Placeholder */
    [contenteditable]:empty:before {
      content: attr(placeholder);
      color: #64748b;
      cursor: text;
    }

    /* Editor Specific Styles */
    .editor-content img {
      max-width: 100%;
      border-radius: 4px;
      border: 1px solid #334155;
      margin: 10px 0;
      transition: all 0.2s;
    }
    .editor-content img.resizable {
      box-shadow: 0 0 0 2px #06b6d4;
    }
    
    /* Animation classes */
    .fade-in {
      animation: fadeIn 0.3s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Glassmorphism utility */
    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* Transition utilities for collapsing panels */
    .panel-transition {
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden; /* Important for hiding content during collapse */
    }
    
    .panel-closed-width {
      width: 0 !important;
      padding-left: 0 !important;
      padding-right: 0 !important;
      border-right: none !important;
      border-left: none !important;
      opacity: 0;
    }

    .panel-closed-height {
      height: 0 !important;
      padding-top: 0 !important;
      padding-bottom: 0 !important;
      border-top: none !important;
      border-bottom: none !important;
      opacity: 0;
    }

    /* AI Loading State */
    .ai-loading {
      position: relative;
      overflow: hidden;
    }
    .ai-loading::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(6, 182, 212, 0.2), transparent);
      transform: translateX(-100%);
      animation: shimmer 1.5s infinite;
    }
    @keyframes shimmer {
      100% { transform: translateX(100%); }
    }
  </style>
</head>
<body class="bg-tech-bg text-slate-200 font-sans h-screen overflow-hidden flex flex-col md:flex-row">

  <!-- Notification Toast Area -->
  <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2 pointer-events-none"></div>

  <!-- SIDEBAR (Navigation & List) -->
  <aside id="sidebar-left" class="panel-transition w-full md:w-80 flex flex-col border-r border-tech-border bg-tech-panel h-[35vh] md:h-full shrink-0">
    <!-- App Header -->
    <div class="p-4 border-b border-tech-border flex items-center justify-between shrink-0">
      <div class="flex items-center gap-2 text-tech-accent animate-pulse">
        <i class="fa-solid fa-microchip text-xl"></i>
        <h1 class="font-mono text-lg font-bold tracking-wider">ZETTEL_AI</h1>
      </div>
      <div class="flex gap-2">
        <button onclick="saveNotes()" title="匯出/保存 (JSON)" class="text-slate-400 hover:text-tech-accent transition">
          <i class="fa-solid fa-floppy-disk"></i>
        </button>
        <label for="import-notes" title="導入 (JSON)" class="text-slate-400 hover:text-tech-accent transition cursor-pointer">
          <i class="fa-solid fa-file-import"></i>
        </label>
        <input type="file" id="import-notes" accept=".json" class="hidden" onchange="importNotes()" />
      </div>
    </div>

    <!-- Search & Filter -->
    <div class="p-3 border-b border-tech-border bg-slate-800/50 shrink-0">
      <div class="relative mb-2">
        <i class="fa-solid fa-search absolute left-3 top-3 text-slate-500 text-xs"></i>
        <input type="text" id="search-input" placeholder="搜尋標題或內容..." 
               class="w-full bg-slate-900 border border-slate-700 rounded text-sm px-8 py-2 focus:outline-none focus:border-tech-accent focus:shadow-neon transition text-slate-200 placeholder-slate-600">
      </div>
      <select id="tag-filter" onchange="filterNotes()" class="w-full bg-slate-900 border border-slate-700 rounded text-sm px-2 py-1.5 text-slate-300 focus:outline-none focus:border-tech-accent">
        <option value="">所有標籤</option>
      </select>
    </div>

    <!-- Note List -->
    <div id="note-list" class="flex-1 overflow-y-auto p-2 space-y-2">
      <!-- Items generated by JS -->
    </div>

    <!-- Add New Button (Mobile/Desktop) -->
    <div class="p-4 border-t border-tech-border shrink-0">
      <button onclick="createNewNote()" class="w-full bg-tech-accent/10 border border-tech-accent text-tech-accent hover:bg-tech-accent hover:text-slate-900 font-mono py-2 rounded transition-all duration-300 shadow-neon flex items-center justify-center gap-2 group">
        <i class="fa-solid fa-plus transition-transform group-hover:rotate-90"></i>
        <span>建立新資料卡</span>
      </button>
    </div>
  </aside>

  <!-- MAIN AREA (Editor) -->
  <main class="flex-1 flex flex-col h-[65vh] md:h-full relative bg-tech-bg bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9InJnYmEoMjU1LDI1NSwyNTUsMC4wNSkiLz48L3N2Zz4=')]">
    
    <!-- Editor Header / Toolbar -->
    <header class="h-16 border-b border-tech-border glass-panel flex items-center justify-between px-4 md:px-6 shrink-0 z-10">
      <div class="flex items-center gap-4 w-full overflow-hidden">
        <!-- Toggle Left Sidebar Button -->
        <button onclick="togglePanel('left')" class="text-slate-400 hover:text-white transition p-2 rounded hover:bg-slate-700/50 shrink-0" title="切換導航欄">
            <i class="fa-solid fa-bars"></i>
        </button>

        <input type="text" id="note-title" placeholder="輸入資料卡標題..." 
               class="bg-transparent border-none text-lg md:text-2xl font-bold text-white placeholder-slate-600 focus:outline-none w-full font-mono tracking-wide min-w-0" />
      </div>
      
      <div class="flex items-center gap-2 shrink-0 ml-2">
        <span id="save-status" class="text-xs text-slate-500 font-mono hidden lg:block">已同步</span>
        <button onclick="deleteCurrentNote()" id="btn-delete" class="hidden text-red-500 hover:bg-red-500/10 p-2 rounded transition border border-transparent hover:border-red-500/50" title="刪除此卡片">
          <i class="fa-solid fa-trash-can"></i>
        </button>
        
        <!-- Toggle Right Sidebar Button -->
        <div class="h-6 w-px bg-slate-700 mx-2 hidden md:block"></div>
        <button onclick="togglePanel('right')" class="text-slate-400 hover:text-tech-secondary transition p-2 rounded hover:bg-slate-700/50" title="切換資訊欄">
            <i class="fa-solid fa-columns"></i>
        </button>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="px-6 py-2 border-b border-tech-border bg-slate-800/30 flex flex-wrap items-center gap-2 overflow-x-auto shrink-0">
      <div class="flex bg-slate-900 rounded border border-slate-700 p-0.5">
        <button onclick="formatText('bold')" class="p-1.5 px-3 hover:bg-slate-700 rounded text-slate-300 transition" title="粗體"><i class="fa-solid fa-bold"></i></button>
        <button onclick="formatText('italic')" class="p-1.5 px-3 hover:bg-slate-700 rounded text-slate-300 transition" title="斜體"><i class="fa-solid fa-italic"></i></button>
        <button onclick="formatText('underline')" class="p-1.5 px-3 hover:bg-slate-700 rounded text-slate-300 transition" title="底線"><i class="fa-solid fa-underline"></i></button>
      </div>
      
      <div class="h-6 w-px bg-slate-700 mx-1"></div>

      <select id="fontSizeSelect" onchange="changeFontSize(this.value)" class="bg-slate-900 border border-slate-700 text-slate-300 text-xs rounded p-1.5 outline-none">
        <option value="3">一般</option>
        <option value="4">標題 M</option>
        <option value="6">標題 L</option>
      </select>

      <div class="h-6 w-px bg-slate-700 mx-1"></div>

      <label class="cursor-pointer bg-slate-900 hover:bg-slate-700 border border-slate-700 text-slate-300 text-xs rounded p-1.5 px-3 transition flex items-center gap-2">
        <i class="fa-solid fa-image"></i> 插入圖片
        <input type="file" id="imageUpload" accept="image/*" onchange="insertImage(this)" class="hidden">
      </label>
    </div>

    <!-- Content Area -->
    <div class="flex-1 flex flex-col md:flex-row overflow-hidden relative">
      
      <!-- Editor Body -->
      <div class="flex-1 overflow-y-auto p-6 relative">
        <div id="editor-content" class="editor-content w-full h-full min-h-[300px] outline-none text-slate-300 leading-relaxed text-lg" 
             contenteditable="true" placeholder="在此輸入系統資料..."></div>
      </div>

      <!-- Right Panel: Metadata (Tags & Links) -->
      <aside id="sidebar-right" class="panel-transition w-full md:w-72 border-t md:border-t-0 md:border-l border-tech-border bg-slate-900/50 p-4 overflow-y-auto shrink-0 h-[35vh] md:h-full">
        
        <!-- Gemini AI Section -->
        <div class="mb-6 p-3 rounded-lg border border-tech-secondary/30 bg-slate-800/30">
          <h3 class="text-xs font-mono text-white mb-3 uppercase tracking-wider flex items-center">
            <i class="fa-solid fa-sparkles text-yellow-400 mr-2 animate-pulse"></i> Gemini AI 運算核心
          </h3>
          <div class="grid grid-cols-1 gap-2">
            <button onclick="aiAutoTag()" id="btn-ai-tag" class="text-left px-3 py-2 bg-slate-900 border border-slate-700 rounded hover:border-yellow-400 hover:text-yellow-400 transition text-sm flex items-center group">
              <i class="fa-solid fa-tags w-6 text-slate-500 group-hover:text-yellow-400"></i>
              <span>✨ 智能標記</span>
            </button>
            <button onclick="aiSummarize()" id="btn-ai-summary" class="text-left px-3 py-2 bg-slate-900 border border-slate-700 rounded hover:border-yellow-400 hover:text-yellow-400 transition text-sm flex items-center group">
              <i class="fa-solid fa-file-lines w-6 text-slate-500 group-hover:text-yellow-400"></i>
              <span>✨ 重點摘要</span>
            </button>
            <button onclick="aiContinue()" id="btn-ai-continue" class="text-left px-3 py-2 bg-slate-900 border border-slate-700 rounded hover:border-yellow-400 hover:text-yellow-400 transition text-sm flex items-center group">
              <i class="fa-solid fa-pen-nib w-6 text-slate-500 group-hover:text-yellow-400"></i>
              <span>✨ 靈感續寫</span>
            </button>
          </div>
        </div>

        <!-- Tags Section -->
        <div class="mb-6">
          <h3 class="text-xs font-mono text-tech-accent mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
            <i class="fa-solid fa-tags mr-1"></i> 資料標籤
          </h3>
          <div class="flex gap-2 mb-2">
            <input type="text" id="tag-input" placeholder="輸入新標籤..." class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm focus:border-tech-accent outline-none">
            <button onclick="addTag()" class="bg-slate-700 hover:bg-tech-accent hover:text-slate-900 px-3 rounded text-sm transition"><i class="fa-solid fa-plus"></i></button>
          </div>
          <div class="mb-2">
             <select id="tag-history" onchange="addTagFromHistory(this)" class="w-full bg-slate-800 border-none text-xs text-slate-400 p-1">
               <option value="">+ 從歷史標籤選擇</option>
             </select>
          </div>
          <div id="active-tags" class="flex flex-wrap gap-2">
            <!-- Tags go here -->
          </div>
        </div>

        <!-- Linked Notes Section -->
        <div>
          <h3 class="text-xs font-mono text-tech-secondary mb-2 uppercase tracking-wider border-b border-slate-700 pb-1">
            <i class="fa-solid fa-link mr-1"></i> 連結網絡
          </h3>
          <div class="relative mb-2">
             <input list="link-suggestions" id="link-input" placeholder="搜尋筆記以連結..." 
                    class="w-full bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm focus:border-tech-secondary outline-none">
             <datalist id="link-suggestions"></datalist>
             <button onclick="addLinkedNote()" class="absolute right-1 top-1 text-tech-secondary hover:text-white"><i class="fa-solid fa-plus-circle"></i></button>
          </div>
          <div id="linked-notes-list" class="space-y-2">
            <!-- Linked Cards go here -->
          </div>
        </div>

        <!-- Action Button (Save) -->
        <div class="mt-8">
            <button onclick="updateCurrentNote()" id="btn-save-update" class="w-full bg-tech-success/10 border border-tech-success text-tech-success hover:bg-tech-success hover:text-slate-900 py-2 rounded font-mono text-sm transition shadow-neon-green">
                <i class="fa-regular fa-floppy-disk mr-1"></i> 保存變更
            </button>
        </div>

      </aside>
    </div>
  </main>

  <script>
    // --- State Management ---
    let notes = [];
    let currentNoteId = null; // null implies "New Note" mode

    // --- Gemini API Configuration ---
    const apiKey = ""; // API Key will be injected by the environment
    
    // --- DOM Elements ---
    const els = {
      list: document.getElementById('note-list'),
      title: document.getElementById('note-title'),
      content: document.getElementById('editor-content'),
      tagInput: document.getElementById('tag-input'),
      tagHistory: document.getElementById('tag-history'),
      activeTags: document.getElementById('active-tags'),
      linkInput: document.getElementById('link-input'),
      linkSuggestions: document.getElementById('link-suggestions'),
      linkedList: document.getElementById('linked-notes-list'),
      searchInput: document.getElementById('search-input'),
      tagFilter: document.getElementById('tag-filter'),
      btnDelete: document.getElementById('btn-delete'),
      btnSaveUpdate: document.getElementById('btn-save-update'),
      status: document.getElementById('save-status'),
      toastContainer: document.getElementById('toast-container'),
      sidebarLeft: document.getElementById('sidebar-left'),
      sidebarRight: document.getElementById('sidebar-right')
    };

    // --- Initialization ---
    window.onload = function() {
      // Load from local storage or mock
      const stored = localStorage.getItem('zettelkasten_notes');
      if (stored) {
        notes = JSON.parse(stored);
      } else {
        // Initial onboarding note
        notes = [{
          id: '1',
          title: '歡迎使用 ZETTEL_AI',
          content: '<b>開始你的數位大腦旅程。</b><br><br>這是一個結合科技風格、卡片盒筆記法與 Gemini AI 的系統。<br><br><b>✨ 新功能：</b>在右側面板，你可以找到三個 AI 按鈕：<br>1. <b>智能標記</b>：自動分析內容並加上標籤。<br>2. <b>重點摘要</b>：幫你總結長篇大論。<br>3. <b>靈感續寫</b>：當你靈感枯竭時，讓 AI 幫你寫下去。<br><br>點擊上方工具列的按鈕可以開合左右面板，讓寫作更專注。',
          tags: ['System', 'Help', 'AI'],
          linkedNotes: []
        }];
      }
      renderNoteList();
      updateTagHistory();
      renderLinkSuggestions();
      createNewNote(); // Start in create mode
    };

    // --- Gemini AI Functions ---

    async function callGemini(prompt, systemInstruction = "") {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
                maxOutputTokens: 1000,
                temperature: 0.7
            }
        };
        if (systemInstruction) {
            payload.systemInstruction = { parts: [{ text: systemInstruction }] };
        }

        const delays = [1000, 2000, 4000, 8000, 16000];
        for (let i = 0; i <= 5; i++) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
            } catch (e) {
                 if (i === 5) throw e;
                 await new Promise(r => setTimeout(r, delays[i]));
            }
        }
    }

    async function aiAutoTag() {
        const text = els.content.innerText.trim();
        if (text.length < 10) {
            showToast("內容太短，無法分析", "error");
            return;
        }
        
        const btn = document.getElementById('btn-ai-tag');
        setLoading(btn, true);

        try {
            const prompt = `分析以下文字，產生 3 到 5 個相關的關鍵字標籤。請只回傳標籤，並用半形逗號分隔，不要有其他文字。文字內容：\n${text}`;
            const result = await callGemini(prompt);
            
            const tags = result.split(',').map(t => t.trim()).filter(t => t);
            
            let addedCount = 0;
            const currentTags = Array.from(els.activeTags.querySelectorAll('.tag-chip span')).map(s => s.textContent);
            
            tags.forEach(tag => {
                if (!currentTags.includes(tag)) {
                    addTagToUI(tag);
                    addedCount++;
                }
            });

            if (addedCount > 0) {
                showToast(`已新增 ${addedCount} 個 AI 標籤`, "success");
            } else {
                showToast("未發現新的標籤建議", "info");
            }

        } catch (error) {
            console.error(error);
            showToast("AI 分析失敗，請稍後再試", "error");
        } finally {
            setLoading(btn, false);
        }
    }

    async function aiSummarize() {
        const text = els.content.innerText.trim();
        if (text.length < 30) {
            showToast("內容太短，無需摘要", "error");
            return;
        }

        const btn = document.getElementById('btn-ai-summary');
        setLoading(btn, true);

        try {
            const prompt = `請為以下文章撰寫一段簡短的摘要（約 50-80 字），語氣專業且客觀。文章內容：\n${text}`;
            const summary = await callGemini(prompt);
            
            const summaryHTML = `<blockquote style="border-left: 3px solid #f59e0b; padding-left: 10px; color: #cbd5e1; margin: 10px 0; background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: 4px;"><strong>✨ AI 摘要：</strong>${summary}</blockquote><p><br></p>`;
            
            // Insert at the beginning
            els.content.innerHTML = summaryHTML + els.content.innerHTML;
            showToast("摘要已生成", "success");

        } catch (error) {
            console.error(error);
            showToast("AI 摘要生成失敗", "error");
        } finally {
            setLoading(btn, false);
        }
    }

    async function aiContinue() {
        const text = els.content.innerText.trim();
        if (text.length < 10) {
            showToast("請先輸入一些內容讓 AI 參考", "info");
            return;
        }

        const btn = document.getElementById('btn-ai-continue');
        setLoading(btn, true);

        try {
            // Take the last 1000 characters for context to save tokens and keep relevance
            const context = text.slice(-1000);
            const prompt = `請接續以下文字繼續撰寫，保持風格一致，長度約 50-100 字。不要重複結尾，直接接續。內容：\n${context}`;
            const continuation = await callGemini(prompt);
            
            // Append to editor
            // We use a clean way to append text to avoid messing up HTML too much, 
            // but for a simple editor appending HTML/Text is okay.
            const span = document.createElement('span');
            span.innerHTML = continuation;
            span.classList.add('fade-in'); // animate it
            els.content.appendChild(span);
            
            // Scroll to bottom
            els.content.scrollTop = els.content.scrollHeight;
            showToast("AI 已完成續寫", "success");

        } catch (error) {
            console.error(error);
            showToast("AI 續寫失敗", "error");
        } finally {
            setLoading(btn, false);
        }
    }

    function setLoading(btn, isLoading) {
        if (isLoading) {
            btn.classList.add('ai-loading', 'pointer-events-none');
            const icon = btn.querySelector('i');
            icon.dataset.originalClass = icon.className;
            icon.className = 'fa-solid fa-circle-notch fa-spin w-6 text-yellow-400';
        } else {
            btn.classList.remove('ai-loading', 'pointer-events-none');
            const icon = btn.querySelector('i');
            if (icon.dataset.originalClass) {
                icon.className = icon.dataset.originalClass;
            }
        }
    }

    // --- Core Operations ---

    function genId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    function createNewNote() {
      currentNoteId = null;
      els.title.value = '';
      els.content.innerHTML = '';
      els.btnDelete.classList.add('hidden');
      els.btnSaveUpdate.innerHTML = '<i class="fa-solid fa-plus mr-1"></i> 建立新筆記';
      els.status.textContent = '新資料卡模式';
      
      renderTagsUI([]);
      renderLinkedUI([]);
      
      // Highlight selection in sidebar (remove all)
      document.querySelectorAll('.note-item').forEach(el => el.classList.remove('border-tech-accent', 'bg-slate-800'));
      els.title.focus();
    }

    function loadNote(id) {
      const note = notes.find(n => n.id === id);
      if (!note) return;

      currentNoteId = note.id;
      els.title.value = note.title;
      els.content.innerHTML = note.content;
      
      // Setup UI for edit mode
      els.btnDelete.classList.remove('hidden');
      els.btnSaveUpdate.innerHTML = '<i class="fa-regular fa-floppy-disk mr-1"></i> 更新筆記';
      els.status.textContent = `ID: ${note.id.substring(0,6)}...`;

      renderTagsUI(note.tags || []);
      renderLinkedUI(note.linkedNotes || []);
      
      // Highlight sidebar
      document.querySelectorAll('.note-item').forEach(el => {
        el.classList.remove('border-tech-accent', 'bg-slate-800');
        if(el.dataset.id === id) el.classList.add('border-tech-accent', 'bg-slate-800');
      });

      // Re-attach image listeners
      document.querySelectorAll('#editor-content img').forEach(makeImageResizable);
    }

    function updateCurrentNote() {
      const title = els.title.value.trim();
      const content = els.content.innerHTML;

      if (!title) {
        showToast('錯誤：標題不能為空', 'error');
        return;
      }

      // Get current UI state for tags and links
      const currentTags = Array.from(els.activeTags.querySelectorAll('.tag-chip span')).map(s => s.textContent);
      const currentLinks = Array.from(els.linkedList.querySelectorAll('.link-card')).map(d => d.dataset.id);

      if (currentNoteId) {
        // Update existing
        const index = notes.findIndex(n => n.id === currentNoteId);
        if (index !== -1) {
          notes[index] = { ...notes[index], title, content, tags: currentTags, linkedNotes: currentLinks };
          showToast('資料已更新', 'success');
        }
      } else {
        // Create new
        const newId = genId();
        const newNote = {
          id: newId,
          title,
          content,
          tags: currentTags,
          linkedNotes: currentLinks
        };
        notes.push(newNote);
        currentNoteId = newId;
        
        // Handle bidirectional linking
        currentLinks.forEach(targetId => {
          const target = notes.find(n => n.id === targetId);
          if (target && !target.linkedNotes.includes(newId)) {
            target.linkedNotes.push(newId);
          }
        });
        
        showToast('新資料卡已建立', 'success');
        els.btnDelete.classList.remove('hidden');
        els.btnSaveUpdate.innerHTML = '<i class="fa-regular fa-floppy-disk mr-1"></i> 更新筆記';
      }

      saveToStorage();
      renderNoteList();
      updateTagHistory();
      renderLinkSuggestions();
    }

    function deleteCurrentNote() {
      if (!currentNoteId) return;
      if (!confirm('確認刪除此資料卡？此操作無法復原。')) return;

      // Remove backlinks
      notes.forEach(n => {
        if (n.linkedNotes) {
          n.linkedNotes = n.linkedNotes.filter(id => id !== currentNoteId);
        }
      });

      notes = notes.filter(n => n.id !== currentNoteId);
      saveToStorage();
      renderNoteList();
      renderLinkSuggestions();
      createNewNote();
      showToast('資料已刪除', 'info');
    }

    function saveToStorage() {
      localStorage.setItem('zettelkasten_notes', JSON.stringify(notes));
    }

    // --- UI Layout Management ---

    function togglePanel(side) {
        const isMobile = window.innerWidth < 768;
        
        if (side === 'left') {
            if (isMobile) {
                // Mobile: Toggle height or display
                els.sidebarLeft.classList.toggle('panel-closed-height');
            } else {
                // Desktop: Toggle width
                els.sidebarLeft.classList.toggle('panel-closed-width');
            }
        } else if (side === 'right') {
            // Right panel is usually inside flex-col on mobile, but at bottom
            // logic is same: hide width on desktop, hide height on mobile
             if (isMobile) {
                els.sidebarRight.classList.toggle('panel-closed-height');
            } else {
                els.sidebarRight.classList.toggle('panel-closed-width');
            }
        }
    }

    // --- UI Rendering ---

    function renderNoteList() {
      const filterText = els.searchInput.value.toLowerCase();
      const filterTag = els.tagFilter.value;

      els.list.innerHTML = '';

      const filtered = notes.filter(n => {
        const matchText = n.title.toLowerCase().includes(filterText) || n.content.toLowerCase().includes(filterText);
        const matchTag = filterTag ? (n.tags || []).includes(filterTag) : true;
        return matchText && matchTag;
      });

      filtered.forEach(note => {
        const div = document.createElement('div');
        div.className = 'note-item p-3 border-l-2 border-transparent hover:bg-slate-800 cursor-pointer transition-colors duration-200 group';
        div.dataset.id = note.id;
        if (note.id === currentNoteId) div.classList.add('border-tech-accent', 'bg-slate-800');

        // Extract clean text for preview
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = note.content;
        const previewText = tempDiv.textContent.substring(0, 50) + (tempDiv.textContent.length > 50 ? '...' : '');

        div.innerHTML = `
          <div class="font-bold text-slate-200 mb-1 group-hover:text-tech-accent transition-colors">${note.title}</div>
          <div class="text-xs text-slate-500 font-mono mb-2 line-clamp-1">${previewText || '無內容'}</div>
          <div class="flex flex-wrap gap-1">
            ${(note.tags || []).slice(0, 3).map(t => `<span class="text-[10px] bg-slate-700 text-slate-300 px-1.5 rounded-sm">#${t}</span>`).join('')}
          </div>
        `;
        div.onclick = () => loadNote(note.id);
        els.list.appendChild(div);
      });
    }

    function renderTagsUI(tags) {
      els.activeTags.innerHTML = '';
      tags.forEach(tag => addTagToUI(tag));
    }
    
    function addTagToUI(tag) {
        const chip = document.createElement('div');
        chip.className = 'tag-chip bg-tech-accent/20 border border-tech-accent/50 text-tech-accent px-2 py-1 rounded text-xs flex items-center gap-2 animate-fade-in';
        chip.innerHTML = `
          <span>${tag}</span>
          <button onclick="removeTag(this)" class="hover:text-white"><i class="fa-solid fa-times"></i></button>
        `;
        els.activeTags.appendChild(chip);
    }

    function renderLinkedUI(linkedIds) {
      els.linkedList.innerHTML = '';
      linkedIds.forEach(id => {
        const note = notes.find(n => n.id === id);
        if (note) {
          const card = document.createElement('div');
          card.className = 'link-card bg-slate-800 border border-slate-700 p-2 rounded flex justify-between items-center group hover:border-tech-secondary transition cursor-pointer';
          card.dataset.id = id;
          card.innerHTML = `
            <div onclick="loadNote('${id}')" class="flex-1 overflow-hidden">
               <div class="text-sm font-bold text-slate-300 group-hover:text-tech-secondary truncate"><i class="fa-solid fa-link text-[10px] mr-1"></i> ${note.title}</div>
            </div>
            <button onclick="removeLink(this)" class="text-slate-500 hover:text-red-400 ml-2 px-1"><i class="fa-solid fa-times"></i></button>
          `;
          els.linkedList.appendChild(card);
        }
      });
    }

    function renderLinkSuggestions() {
      els.linkSuggestions.innerHTML = '';
      notes.forEach(note => {
        const opt = document.createElement('option');
        opt.value = note.title;
        opt.dataset.id = note.id; // Datalist doesn't standardly support hidden IDs, handled in logic
        els.linkSuggestions.appendChild(opt);
      });
    }

    function updateTagHistory() {
      // Collect unique tags
      const allTags = new Set();
      notes.forEach(n => (n.tags || []).forEach(t => allTags.add(t)));
      
      // Update Filter
      const currentFilter = els.tagFilter.value;
      els.tagFilter.innerHTML = '<option value="">所有標籤</option>';
      allTags.forEach(tag => {
        const opt = document.createElement('option');
        opt.value = tag;
        opt.textContent = tag;
        els.tagFilter.appendChild(opt);
      });
      els.tagFilter.value = currentFilter;

      // Update Editor History Select
      els.tagHistory.innerHTML = '<option value="">+ 從歷史標籤選擇</option>';
      allTags.forEach(tag => {
        const opt = document.createElement('option');
        opt.value = tag;
        opt.textContent = tag;
        els.tagHistory.appendChild(opt);
      });
    }

    // --- Event Handlers & Helpers ---

    // Search Filter
    els.searchInput.addEventListener('input', renderNoteList);
    
    function filterNotes() {
      renderNoteList();
    }

    // Tag Management
    function addTag() {
      const tag = els.tagInput.value.trim();
      if (!tag) return;
      
      // Check duplicate in current UI
      const currentTags = Array.from(els.activeTags.querySelectorAll('.tag-chip span')).map(s => s.textContent);
      if (currentTags.includes(tag)) return;

      addTagToUI(tag);
      els.tagInput.value = '';
    }

    function addTagFromHistory(select) {
      const tag = select.value;
      if (!tag) return;
      
      els.tagInput.value = tag;
      addTag();
      select.value = '';
    }

    function removeTag(btn) {
      btn.parentElement.remove();
    }

    // Link Management
    function addLinkedNote() {
      const title = els.linkInput.value;
      if (!title) return;

      const targetNote = notes.find(n => n.title === title);
      
      if (!targetNote) {
        showToast('找不到該標題的筆記', 'error');
        return;
      }
      
      if (targetNote.id === currentNoteId) {
        showToast('無法連結自己', 'error');
        return;
      }

      // Check duplicate in UI
      const existing = Array.from(els.linkedList.querySelectorAll('.link-card')).map(d => d.dataset.id);
      if (existing.includes(targetNote.id)) {
        showToast('已連結此筆記', 'info');
        return;
      }

      renderLinkedUI([...existing, targetNote.id]);
      els.linkInput.value = '';
    }

    function removeLink(btn) {
      btn.parentElement.remove();
    }

    // Editor Formatting
    function formatText(command) {
      document.execCommand(command, false, null);
      els.content.focus();
    }

    function changeFontSize(val) {
      document.execCommand('fontSize', false, val);
      els.content.focus();
    }

    function insertImage(input) {
      const file = input.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        // Insert placeholder logic, but simplified for single file
        // We restore focus and insert
        els.content.focus();
        document.execCommand('insertImage', false, e.target.result);
        
        // Find the image just inserted (it will be the last one usually, or we can add resize logic to all)
        setTimeout(() => {
          document.querySelectorAll('#editor-content img').forEach(makeImageResizable);
        }, 100);
      };
      reader.readAsDataURL(file);
      input.value = '';
    }

    function makeImageResizable(img) {
        if(img.dataset.resizable) return;
        img.dataset.resizable = "true";
        
        img.addEventListener('click', function(e) {
            e.stopPropagation();
            // Deselect others
            document.querySelectorAll('img').forEach(i => i.classList.remove('resizable'));
            img.classList.add('resizable');
        });
    }

    // Click outside to deselect images
    document.addEventListener('click', function(e) {
        if (!e.target.closest('img')) {
            document.querySelectorAll('img').forEach(i => i.classList.remove('resizable'));
        }
    });

    // Import / Export
    function saveNotes() {
      const dataStr = JSON.stringify(notes, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `zettelkasten_backup_${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('備份檔案已下載', 'success');
    }

    function importNotes() {
        const fileInput = document.getElementById('import-notes');
        const file = fileInput.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (!Array.isArray(imported)) throw new Error("Format");
                
                // Merge logic: append distinct IDs
                const existingIds = new Set(notes.map(n => n.id));
                let count = 0;
                
                imported.forEach(n => {
                    if(!n.id) n.id = genId();
                    if(!existingIds.has(n.id)) {
                        notes.push(n);
                        existingIds.add(n.id);
                        count++;
                    }
                });

                saveToStorage();
                renderNoteList();
                updateTagHistory();
                renderLinkSuggestions();
                showToast(`成功導入 ${count} 則筆記`, 'success');
            } catch (err) {
                showToast('檔案格式錯誤', 'error');
            }
            fileInput.value = '';
        };
        reader.readAsText(file);
    }

    // Toast Notification
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      const colors = {
        'success': 'border-tech-success text-tech-success bg-slate-900',
        'error': 'border-tech-danger text-tech-danger bg-slate-900',
        'info': 'border-tech-accent text-tech-accent bg-slate-900'
      };
      
      toast.className = `p-3 rounded border shadow-lg flex items-center gap-2 min-w-[200px] animate-fade-in ${colors[type]}`;
      toast.innerHTML = `
        <i class="fa-solid ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
        <span class="text-sm font-mono">${message}</span>
      `;
      
      els.toastContainer.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-10px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

  </script>
</body>
</html>
